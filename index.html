<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ Ramallah Schools Project</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// =======================
// 1ï¸âƒ£ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
// =======================
var map = L.map("map").setView([31.9, 35.2], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

// =======================
// 2ï¸âƒ£ Icons
// =======================
var schoolIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/167/167707.png",
  iconSize: [25,25]
});

var hospitalIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/2967/2967350.png",
  iconSize: [25,25]
});

var clinicIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/4320/4320337.png",
  iconSize: [22,22]
});

var wellIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
  iconSize: [22,22]
});

// =======================
// 3ï¸âƒ£ Layer Variables
// =======================
var settlementsLayer, schoolsLayer, coloniesLayer;
var roadsLayer, hospitalsLayer, clinicsLayer, wellsLayer;
var wadisLayer, naturalLayer, militaryLayer, outpostsLayer, quarriesLayer;
var proposedLayer = L.layerGroup();

// =======================
// 4ï¸âƒ£ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©
// =======================
fetch("tgmooat.json")
.then(r => r.json())
.then(data => {

  settlementsLayer = L.geoJSON(data, {
    style: {
      color: "#333",
      weight: 1,
      fillColor: "#dddddd",
      fillOpacity: 0.4
    }
  }).addTo(map);

  map.fitBounds(settlementsLayer.getBounds());
  loadSchools();
});

// =======================
// 5ï¸âƒ£ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ + Ø§Ù„ØªØ­Ù„ÙŠÙ„
// =======================
function loadSchools(){
fetch("Ramallah_Schools.json")
.then(r => r.json())
.then(data => {

  schoolsLayer = L.geoJSON(data, {
    pointToLayer: (f, latlng) =>
      L.marker(latlng, {icon: schoolIcon})
       .bindPopup("<b>Ù…Ø¯Ø±Ø³Ø©</b>")
  }).addTo(map);

  analyze(data);
});
}

function analyze(schoolsData){

settlementsLayer.eachLayer(layer => {

  let count = 0;
  schoolsData.features.forEach(s =>
    turf.booleanPointInPolygon(s, layer.feature) && count++
  );

  let p = layer.feature.properties || {};
  let name = p["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"] || p["NAME"] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  let pop  = p["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || p["population"] || 0;

  let needed = Math.ceil(pop / 3000);
  let deficit = needed - count;

  let color = deficit > 0 ? "#e74c3c" : "#2ecc71";

  if (deficit > 0){
    let c = turf.centroid(layer.feature);
    L.marker([c.geometry.coordinates[1], c.geometry.coordinates[0]])
    .bindPopup(
      "<b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©</b><hr>" +
      "Ø§Ù„ØªØ¬Ù…Ø¹: " + name + "<br>" +
      "Ø³Ø¹Ø± ØªÙ‚Ø¯ÙŠØ±ÙŠ: 600000 $"
    ).addTo(proposedLayer);
  }

  layer.setStyle({ fillColor: color, fillOpacity: 0.6 });

  layer.bindPopup(
    "<b>ØªØ¬Ù…Ø¹ Ø³ÙƒÙ†ÙŠ</b><hr>" +
    "Ø§Ù„Ø§Ø³Ù…: " + name + "<br>" +
    "Ø§Ù„Ø³ÙƒØ§Ù†: " + pop + "<br>" +
    "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: " + count + "<br>" +
    "Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: " + needed
  );
});

proposedLayer.addTo(map);
loadOtherLayers();
}

// =======================
// 6ï¸âƒ£ Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø¹Ø§Ù…Ø©
// =======================
function simpleLayer(file, options, popupText, callback){
fetch(file)
.then(r => r.json())
.then(data => {
  let layer = L.geoJSON(data, options).addTo(map);
  layer.eachLayer(l => l.bindPopup("<b>"+popupText+"</b>"));
  callback(layer);
});
}

// =======================
// 7ï¸âƒ£ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù„ÙŠØ±Ø§Øª
// =======================
function loadOtherLayers(){

// Ø·Ø±Ù‚
simpleLayer("roads.json",
  {style:{color:"#555", weight:3, dashArray:"5,5"}},
  "Ø·Ø±ÙŠÙ‚", l => roadsLayer = l
);

// Ø£ÙˆØ¯ÙŠØ©
simpleLayer("wadis.geojson",
  {style:{color:"#00bcd4", weight:2}},
  "ÙˆØ§Ø¯ÙŠ", l => wadisLayer = l
);

// Ù…Ù†Ø§Ø·Ù‚ Ø·Ø¨ÙŠØ¹ÙŠØ©
simpleLayer("natural.json",
  {style:{color:"green", fillColor:"#81c784", fillOpacity:0.4}},
  "Ù…Ù†Ø·Ù‚Ø© Ø·Ø¨ÙŠØ¹ÙŠØ©", l => naturalLayer = l
);

// Ù…Ù†Ø§Ø·Ù‚ Ø¹Ø³ÙƒØ±ÙŠØ©
simpleLayer("military.geojson",
  {style:{color:"black", fillColor:"#b71c1c", fillOpacity:0.4}},
  "Ù…Ù†Ø·Ù‚Ø© Ø¹Ø³ÙƒØ±ÙŠØ©", l => militaryLayer = l
);

// ÙƒØ³Ø§Ø±Ø§Øª
simpleLayer("quarries.geojson",
  {style:{color:"#795548", fillOpacity:0.5}},
  "ÙƒØ³Ø§Ø±Ø©", l => quarriesLayer = l
);

// =======================
// Ù…Ø³ØªØ´ÙÙŠØ§Øª
// =======================
fetch("hospitals.geojson")
.then(r=>r.json())
.then(d=>{
  hospitalsLayer = L.geoJSON(d,{
    pointToLayer:(f,latlng)=>L.marker(latlng,{icon:hospitalIcon})
      .bindPopup("<b>Ù…Ø³ØªØ´ÙÙ‰</b>")
  }).addTo(map);
});

// =======================
// Ø¹ÙŠØ§Ø¯Ø§Øª
// =======================
fetch("clinics.geojson")
.then(r=>r.json())
.then(d=>{
  clinicsLayer = L.geoJSON(d,{
    pointToLayer:(f,latlng)=>L.marker(latlng,{icon:clinicIcon})
      .bindPopup("<b>Ø¹ÙŠØ§Ø¯Ø©</b>")
  }).addTo(map);
});

// =======================
// Ø¢Ø¨Ø§Ø±
// =======================
fetch("Wells.geojson")
.then(r=>r.json())
.then(d=>{
  wellsLayer = L.geoJSON(d,{
    pointToLayer:(f,latlng)=>L.marker(latlng,{icon:wellIcon})
      .bindPopup("<b>Ø¨Ø¦Ø± Ù…ÙŠØ§Ù‡</b>")
  }).addTo(map);
});

// =======================
// Ø¨Ø¤Ø± (Ø¯Ø§Ø¦Ø±Ø© Ø¨Ù†ÙØ³Ø¬ÙŠØ©)
// =======================
fetch("outposts.geojson")
.then(r=>r.json())
.then(d=>{
  outpostsLayer = L.geoJSON(d,{
    pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
      radius:6,
      color:"#6a1b9a",
      fillColor:"#9c27b0",
      fillOpacity:0.7
    }).bindPopup("<b>Ø¨Ø¤Ø±Ø© Ø§Ø³ØªØ¹Ù…Ø§Ø±ÙŠØ©</b>")
  }).addTo(map);
});

// =======================
// Ù…Ø³ØªÙˆØ·Ù†Ø§Øª
// =======================
fetch("settlements.geojson")
.then(r=>r.json())
.then(d=>{
  coloniesLayer = L.geoJSON(d,{
    style:{color:"red", weight:2, fillOpacity:0.3}
  }).addTo(map);

  layerControl();
});
}

// =======================
// 8ï¸âƒ£ Layer Control
// =======================
function layerControl(){
L.control.layers(null,{
  "Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©": settlementsLayer,
  "Ø§Ù„Ù…Ø¯Ø§Ø±Ø³": schoolsLayer,
  "Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª": coloniesLayer,
  "Ø§Ù„Ø¨Ø¤Ø±": outpostsLayer,
  "Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù‚ØªØ±Ø­Ø©": proposedLayer,
  "Ø§Ù„Ø·Ø±Ù‚": roadsLayer,
  "Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª": hospitalsLayer,
  "Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª": clinicsLayer,
  "Ø§Ù„Ø¢Ø¨Ø§Ø±": wellsLayer,
  "Ø§Ù„Ø£ÙˆØ¯ÙŠØ©": wadisLayer,
  "Ù…Ù†Ø§Ø·Ù‚ Ø·Ø¨ÙŠØ¹ÙŠØ©": naturalLayer,
  "Ù…Ù†Ø§Ø·Ù‚ Ø¹Ø³ÙƒØ±ÙŠØ©": militaryLayer,
  "ÙƒØ³Ø§Ø±Ø§Øª": quarriesLayer
}).addTo(map);
}
</script>

</body>
</html>
