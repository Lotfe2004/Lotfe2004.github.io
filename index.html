<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ Ramallah Schools Project</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }
</style>
</head>

<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// =======================
// 1ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
// =======================
var map = L.map("map").setView([31.9, 35.2], 11);

// =======================
// 2ï¸âƒ£ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø§Ø³
// =======================
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

var tgLayer;
var schoolsData;
var settlementsBuffer = null;

// =======================
// 3ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª + Buffer
// =======================
fetch("settlements.geojson")
  .then(res => res.json())
  .then(function(data){

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª
    L.geoJSON(data, {
      style: {
        color: "purple",
        weight: 2,
        fillOpacity: 0.5
      }
    }).addTo(map);

    // Buffer 1000 Ù…ØªØ±
    settlementsBuffer = turf.buffer(data, 1000, { units: "meters" });

    // Ø¹Ø±Ø¶ Ø§Ù„Ù€ Buffer
    L.geoJSON(settlementsBuffer, {
      style: {
        color: "red",
        dashArray: "5,5",
        fillOpacity: 0.1
      }
    }).addTo(map);
  });

// =======================
// 4ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª
// =======================
fetch("tgmooat.json")
  .then(response => response.json())
  .then(function(tgData){

    tgLayer = L.geoJSON(tgData, {
      style: {
        color: "black",
        weight: 1,
        fillColor: "#cccccc",
        fillOpacity: 0.4
      }
    }).addTo(map);

    map.fitBounds(tgLayer.getBounds());

    loadSchools();
  });

// =======================
// 5ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ + Ø§Ù„ØªØ­Ù„ÙŠÙ„
// =======================
function loadSchools(){

fetch("Ramallah_Schools.json")
  .then(response => response.json())
  .then(function(sData){

    schoolsData = sData;

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
    L.geoJSON(schoolsData, {
      pointToLayer: function(feature, latlng){
        return L.circleMarker(latlng, {
          radius: 5,
          color: "blue",
          fillOpacity: 0.8
        });
      }
    }).addTo(map);

    // =======================
    // 6ï¸âƒ£ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙƒØ§Ù†ÙŠ
    // =======================
    tgLayer.eachLayer(function(layer){

      var schoolCount = 0;

      schoolsData.features.forEach(function(school){
        if (turf.booleanPointInPolygon(school, layer.feature)) {
          schoolCount++;
        }
      });

      var name = layer.feature.properties["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
      var pop  = layer.feature.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || 0;

      var needed = Math.ceil(pop / 3000);
      var deficit = needed - schoolCount;

      var status = "Ù…ÙƒØªÙÙŠ";
      var color = "green";

      // =======================
      // 7ï¸âƒ£ ÙÙŠ Ø­Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ù†Ù‚Øµ
      // =======================
      if (deficit > 0) {
        status = "ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ Ù…Ø¯Ø§Ø±Ø³";
        color = "red";

        var center = turf.centroid(layer.feature);

        var suitable = true;
        if (settlementsBuffer) {
          if (turf.booleanPointInPolygon(center, settlementsBuffer)) {
            suitable = false;
          }
        }

        var suitabilityText = suitable
          ? "âœ… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù†Ø§Ø³Ø¨ (Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª)"
          : "âŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨ (Ù‚Ø±ÙŠØ¨ Ù…Ù† Ù…Ø³ØªÙˆØ·Ù†Ø©)";

        L.marker([
          center.geometry.coordinates[1],
          center.geometry.coordinates[0]
        ])
        .addTo(map)
        .bindPopup(
          "<b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©</b><br>" +
          "<b>Ø§Ù„ØªØ¬Ù…Ø¹:</b> " + name + "<br>" +
          suitabilityText
        );
      }

      // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØªØ¬Ù…Ø¹
      layer.setStyle({
        fillColor: color,
        fillOpacity: 0.6
      });

      // Popup Ø§Ù„ØªØ¬Ù…Ø¹
      layer.bindPopup(
        "<b>Ø§Ø³Ù… Ø§Ù„ØªØ¬Ù…Ø¹:</b> " + name + "<br>" +
        "<b>Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†:</b> " + pop + "<br>" +
        "<b>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:</b> " + schoolCount + "<br>" +
        "<b>Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</b> " + needed + "<br>" +
        "<b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> " + status
      );
    });

  });
}
</script>

</body>
</html>
