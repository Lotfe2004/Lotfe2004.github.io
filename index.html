<script>
var map = L.map("map").setView([31.9, 35.2], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

var tgLayer, schoolsLayer, settlementsLayer;
var proposedLayer = L.layerGroup();

var loaded = {
  tg: false,
  schools: false,
  settlements: false
};

// =======================
// Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª
// =======================
fetch("tgmooat.json")
.then(r => r.json())
.then(data => {
  tgLayer = L.geoJSON(data, {
    style: {
      color: "black",
      weight: 1,
      fillColor: "#ccc",
      fillOpacity: 0.5
    }
  }).addTo(map);

  map.fitBounds(tgLayer.getBounds());
  loaded.tg = true;
  tryAnalyze();
});

// =======================
// Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
// =======================
fetch("Ramallah_Schools.json")
.then(r => r.json())
.then(data => {
  schoolsLayer = L.geoJSON(data, {
    pointToLayer: (f, latlng) =>
      L.circleMarker(latlng, {
        radius: 5,
        color: "blue",
        fillOpacity: 0.9
      }).bindPopup("Ù…Ø¯Ø±Ø³Ø©")
  }).addTo(map);

  loaded.schools = true;
  tryAnalyze();
});

// =======================
// Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª
// =======================
fetch("settlements.geojson")
.then(r => r.json())
.then(data => {
  settlementsLayer = L.geoJSON(data, {
    style: {
      color: "red",
      fillColor: "red",
      fillOpacity: 0.4
    }
  }).addTo(map);

  loaded.settlements = true;
  tryAnalyze();
});

// =======================
// Ø§Ù„ØªØ­Ù„ÙŠÙ„ (Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ÙƒÙ„)
// =======================
function tryAnalyze(){
  if (loaded.tg && loaded.schools && loaded.settlements){
    analyze();
  }
}

// =======================
// Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ
// =======================
function analyze(){

tgLayer.eachLayer(layer => {

  let count = 0;

  schoolsLayer.eachLayer(s => {
    if (turf.booleanPointInPolygon(s.feature, layer.feature)) {
      count++;
    }
  });

  let p = layer.feature.properties || {};
  let name = p["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  let pop = p["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || 0;

  let needed = Math.ceil(pop / 3000);
  let deficit = needed - count;

  let color = "green";
  let status = "Ù…ÙƒØªÙÙŠ";

  if (deficit > 0){
    color = "red";
    status = "Ù†Ù‚Øµ Ù…Ø¯Ø§Ø±Ø³";

    let center = turf.centroid(layer.feature);

    let safe = true;
    settlementsLayer.eachLayer(set => {
      let d = turf.distance(center, turf.centroid(set.feature), {units:"kilometers"});
      if (d < 1) safe = false;
    });

    if (safe){
      let price = 5000 * 120;

      L.marker([
        center.geometry.coordinates[1],
        center.geometry.coordinates[0]
      ])
      .bindPopup(
        "<b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­</b><br>" +
        "Ø§Ù„ØªØ¬Ù…Ø¹: " + name + "<br>" +
        "Ø§Ù„ØªÙƒÙ„ÙØ©: " + price + " $"
      )
      .addTo(proposedLayer);
    }
  }

  layer.setStyle({ fillColor: color });

  layer.bindPopup(
    "<b>ØªØ¬Ù…Ø¹ Ø³ÙƒÙ†ÙŠ</b><hr>" +
    "Ø§Ù„Ø§Ø³Ù…: " + name + "<br>" +
    "Ø§Ù„Ø³ÙƒØ§Ù†: " + pop + "<br>" +
    "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: " + count + "<br>" +
    "Ø§Ù„Ø­Ø§Ù„Ø©: " + status
  );
});

proposedLayer.addTo(map);

L.control.layers(null,{
  "Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª": tgLayer,
  "Ø§Ù„Ù…Ø¯Ø§Ø±Ø³": schoolsLayer,
  "Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª": settlementsLayer,
  "Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù‚ØªØ±Ø­Ø©": proposedLayer
}).addTo(map);

}
</script>

