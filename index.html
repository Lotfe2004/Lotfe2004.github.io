<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS – Ramallah Schools Analysis</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body { margin:0; font-family: Arial; }
#map { height: 100vh; }

.popup-title {
  font-weight: bold;
  color: #0a3d62;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// =======================
// إنشاء الخريطة
// =======================
var map = L.map("map").setView([31.9, 35.2], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

// =======================
// Layer Groups (الترتيب مهم)
// =======================
var tgmooatLayer = L.layerGroup().addTo(map);   // تحت
var schoolsLayer = L.layerGroup().addTo(map);
var hospitalsLayer = L.layerGroup().addTo(map);
var settlementsLayer = L.layerGroup().addTo(map);

// =======================
// تحميل المدارس
// =======================
var schoolsData = [];

fetch("schools.json")
.then(res => res.json())
.then(data => {
  schoolsData = data.features;

  L.geoJSON(data, {
    pointToLayer: function (f, latlng) {
      return L.circleMarker(latlng, {
        radius: 5,
        color: "blue",
        fillColor: "blue",
        fillOpacity: 0.8
      });
    },
    onEachFeature: function (f, layer) {
      layer.bindPopup(
        "<div class='popup-title'>مدرسة</div>" +
        "الاسم: " + (f.properties.name || "غير معروف")
      );
    }
  }).addTo(schoolsLayer);
});

// =======================
// تحميل التجمعات السكنية
// =======================
fetch("tgmooat.json")
.then(res => res.json())
.then(data => {

  function countSchools(polygon) {
    let count = 0;
    schoolsData.forEach(s => {
      var pt = L.latLng(
        s.geometry.coordinates[1],
        s.geometry.coordinates[0]
      );
      if (L.polygon(polygon).getBounds().contains(pt)) {
        count++;
      }
    });
    return count;
  }

  function styleTgmooat(feature) {
    let pop = feature.properties.population || 0;
    let schools = countSchools(feature.geometry.coordinates[0]);
    let needed = Math.ceil(pop / 5000);
    let shortage = needed - schools;

    return {
      color: "#000",
      weight: 1,
      fillColor: shortage > 0 ? "#e74c3c" : "#2ecc71",
      fillOpacity: 0.6
    };
  }

  L.geoJSON(data, {
    style: styleTgmooat,
    onEachFeature: function (feature, layer) {

      let pop = feature.properties.population || 0;
      let schools = countSchools(feature.geometry.coordinates[0]);
      let needed = Math.ceil(pop / 5000);
      let shortage = needed - schools;

      let status = shortage > 0 ? "❌ يوجد نقص مدارس" : "✅ كافٍ";

      layer.bindPopup(
        "<div class='popup-title'>تجمع سكني</div>" +
        "الاسم: " + (feature.properties.name || "غير معروف") + "<br>" +
        "عدد السكان: " + pop + "<br>" +
        "عدد المدارس: " + schools + "<br>" +
        "الحالة: " + status
      );
    }
  }).addTo(tgmooatLayer);
});

// =======================
// تحميل المستشفيات
// =======================
fetch("hospitals.geojson")
.then(res => res.json())
.then(data => {
  L.geoJSON(data, {
    pointToLayer: function (f, latlng) {
      return L.marker(latlng);
    },
    onEachFeature: function (f, layer) {
      layer.bindPopup(
        "<div class='popup-title'>مستشفى</div>" +
        (f.properties.name || "")
      );
    }
  }).addTo(hospitalsLayer);
});

// =======================
// تحميل المستوطنات
// =======================
fetch("settlements.geojson")
.then(res => res.json())
.then(data => {
  L.geoJSON(data, {
    style: {
      color: "red",
      fillOpacity: 0.4
    },
    onEachFeature: function (f, layer) {
      layer.bindPopup(
        "<div class='popup-title'>مستوطنة</div>" +
        (f.properties.name || "")
      );
    }
  }).addTo(settlementsLayer);
});

// =======================
// التحكم بالطبقات
// =======================
L.control.layers(null, {
  "التجمعات السكنية": tgmooatLayer,
  "المدارس": schoolsLayer,
  "المستشفيات": hospitalsLayer,
  "المستوطنات": settlementsLayer
}).addTo(map);

</script>
</body>
</html>
