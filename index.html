<script>
// ============================
// MAP
// ============================
var map = L.map("map").setView([31.9, 35.2], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// ============================
// LOAD DATA
// ============================
Promise.all([
    fetch("ramallah.json").then(r=>r.json()),
    fetch("Ramallah_Schools.json").then(r=>r.json())
]).then(([areas, schools]) => {

    var schoolLayer = L.geoJSON(schools,{
        pointToLayer:(f,latlng)=>
            L.circleMarker(latlng,{
                radius:6,
                fillColor:"orange",
                color:"#000",
                weight:1,
                fillOpacity:0.9
            })
    }).addTo(map);

    // ============================
    // ANALYSIS PER AREA
    // ============================
    L.geoJSON(areas,{
        style: f => {
            let count = countSchools(f, schools);

            if(count === 0) return {color:"red", fillOpacity:0.5};
            if(count === 1) return {color:"orange", fillOpacity:0.5};
            return {color:"green", fillOpacity:0.4};
        },

        onEachFeature:(feature, layer)=>{
            let count = countSchools(feature, schools);
            let name = feature.properties.name || "منطقة غير معروفة";

            let status =
                count === 0 ? "❌ نقص حاد" :
                count === 1 ? "⚠️ نقص متوسط" :
                "✔️ مكتفية";

            layer.on("click", ()=>{

                let html = `
                <b>المنطقة:</b> ${name}<br>
                <b>عدد المدارس:</b> ${count}<br>
                <b>الحالة:</b> ${status}
                `;

                // اقتراح موقع مدرسة
                if(count <= 1){
                    let center = turf.centerOfMass(feature);

                    let price = 300 + Math.random()*200;

                    L.marker([
                        center.geometry.coordinates[1],
                        center.geometry.coordinates[0]
                    ]).addTo(map)
                    .bindPopup(`
                        <b>موقع مقترح لبناء مدرسة</b><br>
                        داخل منطقة ${name}<br><br>
                        <b>السعر التقديري:</b><br>
                        ${price.toFixed(0)} دينار / م²
                    `).openPopup();

                    html += "<br><b>✔️ تم اقتراح موقع مدرسة جديدة</b>";
                }

                layer.bindPopup(html).openPopup();
            });
        }
    }).addTo(map);

    map.fitBounds(L.geoJSON(areas).getBounds());
});

// ============================
// COUNT SCHOOLS FUNCTION
// ============================
function countSchools(area, schools){
    let count = 0;
    schools.features.forEach(s=>{
        if(turf.booleanPointInPolygon(s, area)){
            count++;
        }
    });
    return count;
}
</script>
