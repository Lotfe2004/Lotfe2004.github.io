<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ ØªØ­Ù„ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ÙÙŠ Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">

<style>
body { margin:0; font-family: Arial }
#map { height: 100vh }

.header {
  position:absolute;
  top:0; left:0; right:0;
  background:#1e3d59;
  color:white;
  padding:10px;
  z-index:1000;
  text-align:center;
}

table {
  width:100%;
  border-collapse: collapse;
}
td {
  border:1px solid #ccc;
  padding:4px;
  font-size:12px;
}
</style>
</head>

<body>

<div class="header">
<h3>ØªØ­Ù„ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ÙˆØ§Ù‚ØªØ±Ø§Ø­ Ù…ÙˆØ§Ù‚Ø¹ Ø¬Ø¯ÙŠØ¯Ø© â€“ Ù…Ø­Ø§ÙØ¸Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</h3>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// ================= MAP =================
var map = L.map("map").setView([31.9, 35.2], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// ================= POPUP BUILDER =================
function buildPopup(properties){
    let html = "<table>";
    for (let key in properties){
        html += `
          <tr>
            <td><b>${key}</b></td>
            <td>${properties[key]}</td>
          </tr>
        `;
    }
    html += "</table>";
    return html;
}

// ================= LOAD DATA =================
Promise.all([
 fetch("tgmooat.json").then(r=>r.json()),
 fetch("Ramallah_Schools.json").then(r=>r.json()),
 fetch("built_up.json").then(r=>r.json()),
 fetch("roads.json").then(r=>r.json()),
 fetch("settlements.geojson").then(r=>r.json()),
 fetch("outposts.geojson").then(r=>r.json()),
 fetch("military.geojson").then(r=>r.json()),
 fetch("natural.json").then(r=>r.json())
]).then(init);

// ================= INIT =================
function init(data){

let tgmooat = data[0];
let schools = data[1];
let builtUp = data[2];
let roads = data[3];
let settlements = data[4];
let outposts = data[5];
let military = data[6];
let natural = data[7];

// ================= BASE LAYERS =================
L.geoJSON(builtUp,{style:{color:"#999",fillOpacity:0.3}}).addTo(map);
L.geoJSON(roads,{style:{color:"orange"}}).addTo(map);
L.geoJSON(settlements,{style:{color:"red"}}).addTo(map);
L.geoJSON(outposts,{style:{color:"darkred"}}).addTo(map);
L.geoJSON(military,{style:{color:"black"}}).addTo(map);
L.geoJSON(natural,{style:{color:"green"}}).addTo(map);

// ================= SCHOOLS =================
var schoolsLayer = L.geoJSON(schools,{
 pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
   radius:5,
   color:"blue",
   fillOpacity:0.8
 }),
 onEachFeature:(f,l)=>{
   l.bindPopup("<b>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</b><hr>" + buildPopup(f.properties));
 }
}).addTo(map);

// ================= SEARCH =================
L.Control.geocoder({
 defaultMarkGeocode:false
}).on("markgeocode",function(e){
 map.fitBounds(e.geocode.bbox);
}).addTo(map);

// ================= MAIN ANALYSIS =================
L.geoJSON(tgmooat,{
 style:{color:"black",fillOpacity:0.15},
 onEachFeature:function(feature, layer){

   let pop = feature.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || 0;
   let needed = Math.ceil(pop / 3000);

   let insideSchools = schools.features.filter(s =>
     turf.booleanPointInPolygon(s, feature)
   ).length;

   let deficit = insideSchools < needed;

   let analysisHTML = `
     <hr>
     <b>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙƒØ§Ù†ÙŠ</b><br>
     ğŸ‘¥ Ø§Ù„Ø³ÙƒØ§Ù†: ${pop}<br>
     ğŸ« Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${insideSchools}<br>
     ğŸ“Š Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${needed}<br>
     âš ï¸ Ø§Ù„Ø­Ø§Ù„Ø©: ${deficit ? "ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ" : "ÙƒØ§ÙÙ"}
   `;

   if(deficit){
     let center = turf.centroid(feature);

     let price = 80;
     if(turf.booleanPointInPolygon(center, builtUp)) price += 25;
     price += 20;

     L.marker(
       [center.geometry.coordinates[1], center.geometry.coordinates[0]],
       {icon:L.icon({
         iconUrl:"https://cdn-icons-png.flaticon.com/512/167/167707.png",
         iconSize:[28,28]
       })}
     ).addTo(map)
      .bindPopup(`
        <b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ø¯Ø±Ø³Ø© Ù…Ù‚ØªØ±Ø­</b><br>
        ğŸ’° Ø³Ø¹Ø± ØªÙ‚Ø¯ÙŠØ±ÙŠ Ù„Ù„Ø£Ø±Ø¶: ${price} $ / Ù…Â²
      `);

     analysisHTML += "<br>ğŸ—ï¸ ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ù…ÙˆÙ‚Ø¹ Ù…Ø¯Ø±Ø³Ø©";
   }

   layer.bindPopup(
     "<b>Attributes</b><hr>" +
     buildPopup(feature.properties) +
     analysisHTML
   );
 }
}).addTo(map);

}
</script>

</body>
</html>
