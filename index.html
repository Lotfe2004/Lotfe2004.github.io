<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Ramallah Waste Containers (Complete)</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- Leaflet Search CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.8/dist/leaflet-search.min.css" />

    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
            width: 100%;
        }

        .leaflet-control-search .search-button {
            background-color: #333;
            color: #fff;
            border-radius: 4px;
        }

        .my-cluster-icon {
            border: none !important;
            background: transparent !important;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <!-- MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- Leaflet Search JS -->
    <script src="https://unpkg.com/leaflet-search@3.0.8/dist/leaflet-search.min.js"></script>
    <!-- Turf -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <script>
        const map = L.map('map', {
            center: [31.9045, 35.2045],
            zoom: 17.3,
            zoomSnap: 0.5
        });

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
        }).addTo(map);

        const wasteContainersCluster = L.markerClusterGroup({
            iconCreateFunction: cluster => {
                const count = cluster.getChildCount();
                let color = count < 10 ? '#4caf50' : count < 30 ? '#ffc107' : '#9c27b0';

                return L.divIcon({
                    html: `<div style="background-color:${color};color:white;border-radius:50%;width:36px;height:36px;line-height:36px;text-align:center;font-weight:bold;">${count}</div>`,
                    className: 'my-cluster-icon',
                    iconSize: L.point(36, 36)
                });
            }
        });

        const zonesLayer = L.geoJSON(null, {
            style: f => ({
                fillColor: (f.properties.CONTAINER_COUNT || 0) > 50 ? '#9c27b0' : '#ffc107',
                fillOpacity: 0.35,
                color: '#fff',
                weight: 1
            }),
            onEachFeature: (feature, layer) => {
                const name = feature.properties.NAME;
                const count = feature.properties.CONTAINER_COUNT || 0;
                const centroid = turf.centroid(feature).geometry.coordinates;

                const popup = `
                    <b>${name}</b><br>
                    Containers: ${count}<br>
                    Coordinates: ${centroid[1].toFixed(5)}, ${centroid[0].toFixed(5)}
                `;

                layer.bindPopup(popup);
            }
        });

        let wasteData = null;

        $.getJSON('wasteContainer.json').done(WC => {
            wasteData = WC;

            L.geoJSON(WC, {
                pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
                    radius: 5,
                    fillColor: 'orange',
                    color: 'orange',
                    fillOpacity: 0.9
                }).bindPopup(`Waste Type: ${feature.properties.TYPE_OF_WA}`)
            }).eachLayer(layer => wasteContainersCluster.addLayer(layer));

            map.addLayer(wasteContainersCluster);

            $.getJSON('RamallahZones.json').done(RZ => {
                const points = turf.featureCollection(WC.features);

                RZ.features.forEach(zone => {
                    let count = 0;
                    points.features.forEach(pt => {
                        if (turf.booleanPointInPolygon(pt, zone)) count++;
                    });
                    zone.properties.CONTAINER_COUNT = count;
                });

                zonesLayer.addData(RZ).addTo(map);

                const searchControl = new L.Control.Search({
                    layer: zonesLayer,
                    propertyName: 'NAME',
                    marker: false,
                    textPlaceholder: 'Search zone... ',

                    moveToLocation: function (layer, name, map) {
                        const centroid = turf.centroid(layer.feature).geometry.coordinates;
                        map.setView([centroid[1], centroid[0]], 18);
                        layer.openPopup();
                    }
                });

                map.addControl(searchControl);

                L.control.layers(null, {
                    'Zones': zonesLayer,
                    'Waste Containers (Clustered)': wasteContainersCluster
                }).addTo(map);
            });
        });
    </script>
</body>
</html>
