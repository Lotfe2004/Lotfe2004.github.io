<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ Ramallah Schools Project</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// =======================
// 1ï¸âƒ£ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
// =======================
var map = L.map("map").setView([31.9, 35.2], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// =======================
// 2ï¸âƒ£ Icons
// =======================
var schoolIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/167/167707.png",
  iconSize: [25,25]
});

// =======================
// 3ï¸âƒ£ Layers
// =======================
var settlementsLayer, schoolsLayer;
var areaALayer, areaBLayer, areaCLayer;
var proposedLayer = L.layerGroup();

// =======================
// 4ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Areas (A / B / C)
// =======================
fetch("area_A.geojson")
.then(r=>r.json())
.then(d=>{
  areaALayer = L.geoJSON(d,{
    style:{color:"#4caf50", fillOpacity:0.2}
  }).addTo(map);
});

fetch("Area_B.geojson")
.then(r=>r.json())
.then(d=>{
  areaBLayer = L.geoJSON(d,{
    style:{color:"#ffeb3b", fillOpacity:0.2}
  }).addTo(map);
});

fetch("area_C (1).geojson")
.then(r=>r.json())
.then(d=>{
  areaCLayer = d; // Ù†Ø­ØªÙØ¸ Ø¨Ù‡Ø§ Ù„Ù„ØªØ­Ù„ÙŠÙ„ ÙÙ‚Ø·
  L.geoJSON(d,{
    style:{color:"#f44336", fillOpacity:0.2}
  }).addTo(map);
});

// =======================
// 5ï¸âƒ£ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª
// =======================
fetch("tgmooat.json")
.then(r=>r.json())
.then(d=>{
  settlementsLayer = L.geoJSON(d,{
    style:{color:"#333",weight:1,fillColor:"#ddd",fillOpacity:0.4}
  }).addTo(map);

  map.fitBounds(settlementsLayer.getBounds());
  loadSchools();
});

// =======================
// 6ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ + ÙÙ„ØªØ±Ø© Area C
// =======================
function loadSchools(){

fetch("Ramallah_Schools.json")
.then(r=>r.json())
.then(data=>{

  let filteredSchools = {
    type: "FeatureCollection",
    features: []
  };

  data.features.forEach(school => {

    let insideC = false;

    areaCLayer.features.forEach(areaC => {
      if (turf.booleanPointInPolygon(school, areaC)) {
        insideC = true;
      }
    });

    if (!insideC) {
      filteredSchools.features.push(school);
    }
  });

  schoolsLayer = L.geoJSON(filteredSchools,{
    pointToLayer:(f,latlng)=>
      L.marker(latlng,{icon:schoolIcon})
      .bindPopup("<b>Ù…Ø¯Ø±Ø³Ø©</b>")
  }).addTo(map);

  analyze(filteredSchools);
});
}

// =======================
// 7ï¸âƒ£ Ø§Ù„ØªØ­Ù„ÙŠÙ„
// =======================
function analyze(schoolsData){

settlementsLayer.eachLayer(layer=>{

  let count = 0;
  schoolsData.features.forEach(s=>{
    if(turf.booleanPointInPolygon(s,layer.feature)) count++;
  });

  let p = layer.feature.properties || {};
  let name = p["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"] || p["NAME"] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  let pop  = p["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || 0;

  let needed = Math.ceil(pop/3000);
  let deficit = needed - count;

  let color = deficit>0 ? "#e74c3c" : "#2ecc71";

  if(deficit>0){
    let c = turf.centroid(layer.feature);
    L.marker([c.geometry.coordinates[1],c.geometry.coordinates[0]])
    .bindPopup("<b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©</b>")
    .addTo(proposedLayer);
  }

  layer.setStyle({fillColor:color,fillOpacity:0.6});

  layer.bindPopup(
    "<b>ØªØ¬Ù…Ø¹ Ø³ÙƒÙ†ÙŠ</b><hr>"+
    "Ø§Ù„Ø§Ø³Ù…: "+name+"<br>"+
    "Ø§Ù„Ø³ÙƒØ§Ù†: "+pop+"<br>"+
    "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: "+count
  );
});

proposedLayer.addTo(map);
layerControl();
}

// =======================
// 8ï¸âƒ£ Layer Control
// =======================
function layerControl(){
L.control.layers(null,{
  "Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª": settlementsLayer,
  "Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ (A & B ÙÙ‚Ø·)": schoolsLayer,
  "Area A": areaALayer,
  "Area B": areaBLayer,
  "Area C": L.geoJSON(areaCLayer),
  "Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù‚ØªØ±Ø­Ø©": proposedLayer
}).addTo(map);
}
</script>

</body>
</html>
