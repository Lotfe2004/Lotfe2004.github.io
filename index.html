<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ Ramallah Schools Project</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// =======================
// 1ï¸âƒ£ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
// =======================
var map = L.map("map").setView([31.9, 35.2], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

// =======================
// 2ï¸âƒ£ Ø·Ø¨Ù‚Ø§Øª
// =======================
var tgLayer, schoolsLayer, settlementsLayer, proposedLayer;
proposedLayer = L.layerGroup();

// =======================
// 3ï¸âƒ£ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©
// =======================
fetch("tgmooat.json")
.then(res => res.json())
.then(tgData => {

  tgLayer = L.geoJSON(tgData, {
    style: {
      color: "#333",
      weight: 1,
      fillColor: "#cccccc",
      fillOpacity: 0.5
    }
  }).addTo(map);

  map.fitBounds(tgLayer.getBounds());

  loadSchools();
  loadSettlements();
});

// =======================
// 4ï¸âƒ£ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
// =======================
function loadSchools(){
fetch("Ramallah_Schools.json")
.then(res => res.json())
.then(data => {

  schoolsLayer = L.geoJSON(data, {
    pointToLayer: (f, latlng) =>
      L.circleMarker(latlng, {
        radius: 5,
        color: "blue",
        fillOpacity: 0.9
      }).bindPopup("<b>Ù…Ø¯Ø±Ø³Ø©</b>")
  }).addTo(map);

  analyze();
});
}

// =======================
// 5ï¸âƒ£ Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª
// =======================
function loadSettlements(){
fetch("settlements.geojson")
.then(res => res.json())
.then(data => {

  settlementsLayer = L.geoJSON(data, {
    style: {
      color: "red",
      fillColor: "red",
      fillOpacity: 0.4
    }
  }).addTo(map);
});
}

// =======================
// 6ï¸âƒ£ Ø§Ù„ØªØ­Ù„ÙŠÙ„ + Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­
// =======================
function analyze(){

tgLayer.eachLayer(layer => {

  let schoolsCount = 0;

  schoolsLayer.eachLayer(s => {
    if (turf.booleanPointInPolygon(s.feature, layer.feature)) {
      schoolsCount++;
    }
  });

  let p = layer.feature.properties || {};
  let name = p["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"] || p["name"] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  let pop  = p["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || 0;

  let needed = Math.ceil(pop / 3000);
  let deficit = needed - schoolsCount;

  let status = "Ù…ÙƒØªÙÙŠ";
  let color = "#2ecc71";

  if (deficit > 0) {
    status = "Ù†Ù‚Øµ Ù…Ø¯Ø§Ø±Ø³";
    color = "#e74c3c";

    let center = turf.centroid(layer.feature);

    // ÙØ­Øµ Ø§Ù„Ø¨Ø¹Ø¯ Ø¹Ù† Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª (1000Ù…)
    let safe = true;
    settlementsLayer.eachLayer(set => {
      let d = turf.distance(center, turf.centroid(set.feature), {units:"kilometers"});
      if (d < 1) safe = false;
    });

    if (safe) {
      let area = 5000;
      let price = area * 120;

      L.marker([
        center.geometry.coordinates[1],
        center.geometry.coordinates[0]
      ])
      .bindPopup(
        "<b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­</b><hr>" +
        "<b>Ø§Ù„ØªØ¬Ù…Ø¹:</b> " + name + "<br>" +
        "<b>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</b> " + area + " Ù…Â²<br>" +
        "<b>Ø§Ù„ØªÙƒÙ„ÙØ©:</b> " + price + " $"
      )
      .addTo(proposedLayer);
    }
  }

  layer.setStyle({fillColor: color});

  layer.bindPopup(
    "<b>ØªØ¬Ù…Ø¹ Ø³ÙƒÙ†ÙŠ</b><hr>" +
    "<b>Ø§Ù„Ø§Ø³Ù…:</b> " + name + "<br>" +
    "<b>Ø§Ù„Ø³ÙƒØ§Ù†:</b> " + pop + "<br>" +
    "<b>Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:</b> " + schoolsCount + "<br>" +
    "<b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> " + status
  );
});

proposedLayer.addTo(map);

// =======================
// 7ï¸âƒ£ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø·Ø¨Ù‚Ø§Øª
// =======================
L.control.layers(null, {
  "Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©": tgLayer,
  "Ø§Ù„Ù…Ø¯Ø§Ø±Ø³": schoolsLayer,
  "Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª": settlementsLayer,
  "Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù‚ØªØ±Ø­Ø©": proposedLayer
}).addTo(map);

}
</script>

</body>
</html>
