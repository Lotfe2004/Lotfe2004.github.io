<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ Ramallah Schools</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// =======================
// Ø§Ù„Ø®Ø±ÙŠØ·Ø©
// =======================
var map = L.map("map").setView([31.9,35.2],11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  attribution:"Â© OpenStreetMap"
}).addTo(map);

// =======================
// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
// =======================
var tgLayer;
var schoolsData;
var roadsData;
var settlementsBuffer;

// =======================
// 1ï¸âƒ£ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª (ØªÙØ¶Ø§Ù Ø£ÙˆÙ„Ø§Ù‹)
// =======================
fetch("tgmooat.json")
.then(r=>r.json())
.then(data=>{

  tgLayer = L.geoJSON(data,{
    style:{
      color:"#000",
      weight:1,
      fillColor:"#cccccc",
      fillOpacity:0.4
    },
    onEachFeature:function(feature,layer){
      layer.bringToBack(); // Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹
    }
  }).addTo(map);

  map.fitBounds(tgLayer.getBounds());

  loadSchools();
});

// =======================
// 2ï¸âƒ£ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
// =======================
function loadSchools(){

fetch("Ramallah_Schools.json")
.then(r=>r.json())
.then(data=>{
  schoolsData = data;

  L.geoJSON(data,{
    pointToLayer:(f,latlng)=>
      L.circleMarker(latlng,{
        radius:5,
        color:"blue",
        fillOpacity:0.8
      }),
    onEachFeature:(f,l)=>
      l.bindPopup("ğŸ« Ù…Ø¯Ø±Ø³Ø©")
  }).addTo(map);

  analyzeTgmooat();
});
}

// =======================
// 3ï¸âƒ£ Ø§Ù„Ø·Ø±Ù‚
// =======================
fetch("roads.json")
.then(r=>r.json())
.then(data=>{
  roadsData = data;

  L.geoJSON(data,{
    style:{color:"#555",weight:2}
  }).addTo(map)
  .bindPopup("Ø·Ø±ÙŠÙ‚");
});

// =======================
// 4ï¸âƒ£ Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª + Buffer
// =======================
fetch("settlements.geojson")
.then(r=>r.json())
.then(data=>{

  L.geoJSON(data,{
    style:{color:"purple",fillOpacity:0.4}
  }).addTo(map)
  .bindPopup("Ù…Ø³ØªÙˆØ·Ù†Ø©");

  settlementsBuffer = turf.buffer(data,1000,{units:"meters"});

  L.geoJSON(settlementsBuffer,{
    style:{color:"red",dashArray:"5,5",fillOpacity:0.05}
  }).addTo(map)
  .bindPopup("Ù…Ù†Ø·Ù‚Ø© Ù…Ø±ÙÙˆØ¶Ø© Ù„Ù„Ø¨Ù†Ø§Ø¡");
});

// =======================
// 5ï¸âƒ£ Ø§Ù„ØªØ­Ù„ÙŠÙ„ + Popups
// =======================
function analyzeTgmooat(){

tgLayer.eachLayer(function(layer){

  let schoolCount = 0;
  schoolsData.features.forEach(s=>{
    if(turf.booleanPointInPolygon(s,layer.feature)){
      schoolCount++;
    }
  });

  let name = layer.feature.properties["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  let pop  = layer.feature.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || 0;
  let needed = Math.ceil(pop/3000);
  let deficit = needed - schoolCount;

  let status = deficit>0 ? "Ù†Ù‚Øµ Ù…Ø¯Ø§Ø±Ø³" : "Ù…ÙƒØªÙÙŠ";
  let color  = deficit>0 ? "red" : "green";

  layer.setStyle({fillColor:color});

  // âœ… Popup Ø§Ù„ØªØ¬Ù…Ø¹ (ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ù‹Ø§)
  layer.bindPopup(
    "<b>ğŸ˜ Ø§Ø³Ù… Ø§Ù„ØªØ¬Ù…Ø¹:</b> "+name+"<br>"+
    "<b>ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†:</b> "+pop+"<br>"+
    "<b>ğŸ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:</b> "+schoolCount+"<br>"+
    "<b>ğŸ“Š Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</b> "+needed+"<br>"+
    "<b>âš  Ø§Ù„Ø­Ø§Ù„Ø©:</b> "+status
  );

  // =======================
  // Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ + Popup
  // =======================
  if(deficit>0){

    let center = turf.centroid(layer.feature);
    let score = 30;

    let safe = true;
    if(settlementsBuffer && turf.booleanPointInPolygon(center,settlementsBuffer)){
      safe = false;
    } else score += 40;

    let roadDist = turf.pointToLineDistance(center,roadsData,{units:"meters"});
    if(roadDist<=300) score += 30;

    let price = "Ù…Ù†Ø®ÙØ¶";
    if(score>=80) price="Ù…Ø±ØªÙØ¹";
    else if(score>=60) price="Ù…ØªÙˆØ³Ø·";

    let mColor = score>=80?"green":score>=60?"orange":"red";

    let icon = L.divIcon({
      html:`<div style="
        background:${mColor};
        width:14px;
        height:14px;
        border-radius:50%;
        border:2px solid #000"></div>`
    });

    L.marker(
      [center.geometry.coordinates[1],center.geometry.coordinates[0]],
      {icon:icon}
    ).addTo(map)
    .bindPopup(
      "<b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©</b><br>"+
      "<b>Ø§Ù„ØªØ¬Ù…Ø¹:</b> "+name+"<br>"+
      "<b>Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ù„Ø§Ø¡Ù…Ø©:</b> "+score+"/100<br>"+
      "<b>Ù‚Ø±Ø¨ Ø§Ù„Ø·Ø±Ù‚:</b> "+Math.round(roadDist)+" Ù…<br>"+
      "<b>Ø§Ù„Ø¨Ø¹Ø¯ Ø¹Ù† Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª:</b> "+(safe?"Ø¢Ù…Ù†":"ØºÙŠØ± Ø¢Ù…Ù†")+"<br>"+
      "<b>ğŸ’° ØªØ«Ù…ÙŠÙ† Ø§Ù„Ø£Ø±Ø¶:</b> "+price
    );
  }

});
}
</script>
</body>
</html>
