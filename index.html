<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ â€“ Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<style>
body { margin:0; font-family: Arial }
#map { height: 90vh; }
#header {
  background:#1e3d59; color:white; padding:10px; text-align:center
}
.info {
  background:white; padding:10px; font-size:14px
}
.search {
  padding:6px; width:200px
}
</style>
</head>

<body>

<div id="header">
  <h2>ØªØ­Ù„ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ÙÙŠ Ù…Ø­Ø§ÙØ¸Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</h2>
  <input id="searchBox" class="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØªØ¬Ù…Ø¹ Ø³ÙƒÙ†ÙŠ...">
</div>

<div id="map"></div>

<script>
var map = L.map('map').setView([31.9,35.2],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// ================= Layers =================
var schoolsData, settlementsData, builtUpData;
var schoolLayer, settlementLayer, proposedLayer;

// ================= Load Schools =================
fetch('Ramallah_Schools.json')
.then(r=>r.json())
.then(data=>{
  schoolsData = data;
  schoolLayer = L.geoJSON(data,{
    pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5,color:'red',fillOpacity:0.8})
  }).addTo(map);
});

// ================= Load Built-up =================
fetch('built_up.json')
.then(r=>r.json())
.then(data=> builtUpData = data);

// ================= Load Settlements =================
fetch('settlements.geojson')
.then(r=>r.json())
.then(data=>{
  settlementsData = data;

  settlementLayer = L.geoJSON(data,{
    style:{color:'blue',fillOpacity:0.1},
    onEachFeature:(feature,layer)=>{

      layer.on('click', ()=> analyzeSettlement(feature,layer));
    }
  }).addTo(map);

  map.fitBounds(settlementLayer.getBounds());
});

// ================= Core Analysis =================
function analyzeSettlement(feature, layer){

  var population = feature.properties.population || 0;

  // Count schools inside settlement
  var count = 0;
  schoolsData.features.forEach(s=>{
    if(turf.booleanPointInPolygon(s, feature)) count++;
  });

  // Ù…Ø¹ÙŠØ§Ø± Ø§Ù„Ù†Ù‚Øµ (Ù…Ø«Ø§Ù„)
  var needed = Math.ceil(population / 3000);
  var status = count < needed ? "âŒ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ" : "âœ… ÙƒØ§ÙÙ";

  // Ø§Ù‚ØªØ±Ø§Ø­ Ù…ÙˆÙ‚Ø¹ Ù…Ø¯Ø±Ø³Ø©
  var proposedPoint = null;
  if(count < needed && builtUpData){
    proposedPoint = turf.centroid(feature);
    if(proposedLayer) map.removeLayer(proposedLayer);
    proposedLayer = L.geoJSON(proposedPoint,{
      pointToLayer:(f,ll)=>L.marker(ll)
        .bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©")
    }).addTo(map);
  }

  layer.bindPopup(`
    <b>${feature.properties.name}</b><br>
    ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†: ${population}<br>
    ğŸ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${count}<br>
    ğŸ“Š Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬: ${needed}<br>
    âš ï¸ Ø§Ù„Ø­Ø§Ù„Ø©: ${status}
  `).openPopup();
}

// ================= Search =================
document.getElementById("searchBox").addEventListener("keyup", function(e){
  var value = e.target.value.toLowerCase();
  settlementLayer.eachLayer(l=>{
    var name = l.feature.properties.name.toLowerCase();
    if(name.includes(value)){
      map.fitBounds(l.getBounds());
      l.fire('click');
    }
  });
});

// ================= Controls =================
L.control.layers(null,{
  "Ø§Ù„Ù…Ø¯Ø§Ø±Ø³":schoolLayer,
  "Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©":settlementLayer,
  "Ù…ÙˆÙ‚Ø¹ Ù…Ø¯Ø±Ø³Ø© Ù…Ù‚ØªØ±Ø­":proposedLayer
}).addTo(map);

</script>
</body>
</html>
