<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ ØªØ­Ù„ÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }

.header {
  position:absolute;
  top:0; left:0; right:0;
  background:#1e3d59;
  color:white;
  padding:10px;
  z-index:1000;
  text-align:center;
}

.legend {
  position:absolute;
  bottom:20px;
  right:20px;
  background:white;
  padding:10px;
  font-size:13px;
  z-index:1000;
}
</style>
</head>

<body>

<div class="header">
<h3>ØªØ­Ù„ÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ÙˆØ§Ù‚ØªØ±Ø§Ø­ Ù…ÙˆØ§Ù‚Ø¹ Ø¨Ù†Ø§Ø¦Ù‡Ø§ â€“ Ù…Ø­Ø§ÙØ¸Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</h3>
</div>

<div id="map"></div>

<div class="legend">
<b>Ø¯Ù„Ø§Ù„Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù†</b><br>
ğŸŸ¢ Ù…ÙƒØªÙÙŠ<br>
ğŸ”´ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// ================= MAP =================
var map = L.map("map").setView([31.9, 35.2], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// Pane Ù„Ù„ØªØ¬Ù…Ø¹Ø§Øª (ØªØ­Øª)
map.createPane("tgPane");
map.getPane("tgPane").style.zIndex = 200;

// ================= LOAD DATA =================
Promise.all([
  fetch("tgmooat.json").then(r=>r.json()),
  fetch("Ramallah_Schools.json").then(r=>r.json()),
  fetch("settlements.geojson").then(r=>r.json()),
  fetch("built_up.json").then(r=>r.json()),
  fetch("roads.json").then(r=>r.json())
]).then(init);

// ================= INIT =================
function init(data){

let tgmooat = data[0];
let schools = data[1];
let settlements = data[2];
let built = data[3];
let roads = data[4];

// ===== Other Layers =====
L.geoJSON(built,{style:{color:"#999",fillOpacity:0.3}}).addTo(map);
L.geoJSON(roads,{style:{color:"orange"}}).addTo(map);
L.geoJSON(settlements,{style:{color:"red",fillOpacity:0.4}}).addTo(map);
L.geoJSON(schools,{
 pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5,color:"blue",fillOpacity:0.8})
}).addTo(map);

// ===== Search =====
L.Control.geocoder({defaultMarkGeocode:false})
.on("markgeocode",e=>map.fitBounds(e.geocode.bbox))
.addTo(map);

// ===== Main Analysis =====
let tgLayer = L.geoJSON(tgmooat,{
 pane:"tgPane",
 style: f => {
   let pop = f.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || 0;
   let needed = Math.ceil(pop / 3000);
   let count = schools.features.filter(s =>
     turf.booleanPointInPolygon(s, f)
   ).length;

   return {
     color:"black",
     fillOpacity:0.25,
     fillColor: count < needed ? "red" : "green"
   };
 },

 onEachFeature:(feature, layer)=>{

   let pop = feature.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || 0;
   let needed = Math.ceil(pop / 3000);
   let count = schools.features.filter(s =>
     turf.booleanPointInPolygon(s, feature)
   ).length;

   let deficit = count < needed;

   let html = `
   <b>${feature.properties["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"]}</b><br>
   ğŸ‘¥ Ø§Ù„Ø³ÙƒØ§Ù†: ${pop}<br>
   ğŸ« Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${count}<br>
   ğŸ“Š Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${needed}<br>
   âš ï¸ Ø§Ù„Ø­Ø§Ù„Ø©: ${deficit ? "ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ" : "Ù…ÙƒØªÙÙŠ"}
   `;

   if(deficit){
     let center = turf.centroid(feature);

     let farFromSettlements = settlements.features.every(s =>
       turf.distance(center, s, {units:"kilometers"}) > 0.8
     );

     let insideBuilt = turf.booleanPointInPolygon(center, built);

     let nearRoad = roads.features.some(r =>
       turf.distance(center, r, {units:"kilometers"}) < 0.5
     );

     let suitable = farFromSettlements && insideBuilt && nearRoad;

     let price = 100;
     if(insideBuilt) price += 30;
     if(nearRoad) price += 20;
     if(suitable) price += 20;
     if(!farFromSettlements) price -= 50;

     L.marker([
       center.geometry.coordinates[1],
       center.geometry.coordinates[0]
     ]).addTo(map)
     .bindPopup(`
       <b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©</b><br>
       ğŸ§­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${suitable ? "Ù…Ù†Ø§Ø³Ø¨" : "ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨"}<br>
       ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø£Ø±Ø¶: ${price} $ / Ù…Â²
     `);

     html += `
     <hr>
     ğŸ§­ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${suitable ? "Ù…Ù†Ø§Ø³Ø¨" : "ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨"}<br>
     ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø£Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ: ${price} $ / Ù…Â²
     `;
   }

   layer.bindPopup(html);
 }
}).addTo(map);

map.fitBounds(tgLayer.getBounds());
}
</script>

</body>
</html>
