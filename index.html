<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ Ramallah Schools Project</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body { margin:0; font-family: Arial; }
#map { height:100vh; }
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// ======================
// 1ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
// ======================
var map = L.map("map").setView([31.9, 35.2], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

// ======================
// 2ï¸âƒ£ Layer Groups
// ======================
var settlementsLayer = L.layerGroup().addTo(map);
var schoolsLayer = L.layerGroup().addTo(map);
var proposedLayer = L.layerGroup().addTo(map);

// ======================
// 3ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
// ======================
fetch("Ramallah_Schools.json")
.then(res => res.json())
.then(schoolsData => {

  L.geoJSON(schoolsData, {
    pointToLayer: function (feature, latlng) {
      return L.circleMarker(latlng, {
        radius: 5,
        color: "blue",
        fillOpacity: 0.9
      });
    },
    onEachFeature: function (feature, layer) {
      layer.bindPopup("<b>ğŸ« Ù…Ø¯Ø±Ø³Ø©</b>");
    }
  }).addTo(schoolsLayer);

  loadSettlements(schoolsData);
});

// ======================
// 4ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª + Ø§Ù„ØªØ­Ù„ÙŠÙ„
// ======================
function loadSettlements(schoolsData){

fetch("tgmooat.json")
.then(res => res.json())
.then(data => {

  L.geoJSON(data, {
    style: {
      color: "black",
      weight: 1,
      fillOpacity: 0.6
    },

    onEachFeature: function (feature, layer) {

      let props = feature.properties || {};

      // ===== Ø§Ø³Ù… Ø§Ù„ØªØ¬Ù…Ø¹ (Ù…Ø¤ÙƒØ¯) =====
      let name =
        props.AR_NAME ||
        props.NAME ||
        props.Locality ||
        props.Village_N ||
        props.Name_Ar ||
        props.name ||
        "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

      // ===== Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù† =====
      let population =
        props.POPULATION ||
        props.population ||
        props.POP ||
        props.pop ||
        0;

      // ===== Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ¬Ù…Ø¹ =====
      let schoolCount = 0;
      schoolsData.features.forEach(function (school) {
        if (turf.booleanPointInPolygon(school, feature)) {
          schoolCount++;
        }
      });

      // ===== ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ø¬Ø© =====
      let needed = Math.ceil(population / 3000);
      let deficit = needed - schoolCount;

      let status = deficit > 0 ? "âŒ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ Ù…Ø¯Ø§Ø±Ø³" : "âœ… ÙƒØ§ÙÙ";
      let color  = deficit > 0 ? "red" : "green";

      layer.setStyle({ fillColor: color });

      // ===== Popup Ø§Ù„ØªØ¬Ù…Ø¹ =====
      layer.bindPopup(
        "<b>ğŸ˜ ØªØ¬Ù…Ø¹ Ø³ÙƒÙ†ÙŠ</b><br>" +
        "<b>Ø§Ù„Ø§Ø³Ù…:</b> " + name + "<br>" +
        "<b>Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†:</b> " + population + "<br>" +
        "<b>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:</b> " + schoolCount + "<br>" +
        "<b>Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</b> " + needed + "<br>" +
        "<b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> " + status
      );

      // ===== Ø§Ù‚ØªØ±Ø§Ø­ Ù…ÙˆÙ‚Ø¹ Ù…Ø¯Ø±Ø³Ø© + ØªØ«Ù…ÙŠÙ† =====
      if (deficit > 0) {

        let center = turf.centroid(feature);

        let price =
          population > 20000 ? "Ù…Ø±ØªÙØ¹ ğŸ’°" :
          population > 10000 ? "Ù…ØªÙˆØ³Ø· ğŸ’°" :
          "Ù…Ù†Ø®ÙØ¶ ğŸ’°";

        L.marker([
          center.geometry.coordinates[1],
          center.geometry.coordinates[0]
        ])
        .addTo(proposedLayer)
        .bindPopup(
          "<b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©</b><br>" +
          "<b>Ø§Ù„ØªØ¬Ù…Ø¹:</b> " + name + "<br>" +
          "<b>Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±:</b> Ù†Ù‚Øµ Ù…Ø¯Ø§Ø±Ø³<br>" +
          "<b>ØªØ«Ù…ÙŠÙ† Ø§Ù„Ø£Ø±Ø¶:</b> " + price
        );
      }
    }
  }).addTo(settlementsLayer);

});
}

// ======================
// 5ï¸âƒ£ Layer Control
// ======================
L.control.layers(null, {
  "Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©": settlementsLayer,
  "Ø§Ù„Ù…Ø¯Ø§Ø±Ø³": schoolsLayer,
  "Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù‚ØªØ±Ø­Ø© Ù„Ù…Ø¯Ø§Ø±Ø³": proposedLayer
}).addTo(map);

</script>

</body>
</html>
