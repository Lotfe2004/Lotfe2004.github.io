<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>Ø­Ø§ÙˆÙŠØ§Øª Ù†ÙØ§ÙŠØ§Øª Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ - Ù…Ø·ÙˆØ±</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20n6a9c34z6Gk4TzWwWd/A/52/6W/wzW4b5Ff74P2b2=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        /* Ø³ØªØ§ÙŠÙ„Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© */
        body { margin: 0; height: 100vh; width: 100vw; font-family: Tahoma, Geneva, sans-serif; }
        #map { position: absolute; width: 100%; top: 0; bottom: 0; }
        /* Ø³ØªØ§ÙŠÙ„ Ù…Ø®ØµØµ Ù„Ù€ Tooltip Ø§Ù„Ù…Ù†Ø·Ù‚Ø© */
        .zone-tooltip {
            background-color: #2c3e50; /* Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ† */
            color: white;
            border: 1px solid #34495e;
            opacity: 0.9;
            padding: 4px 8px;
            font-size: 14px;
            font-weight: bold;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        // ----------------------------------------------------
        // 1. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ùˆ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        // ----------------------------------------------------
        let zonesLayer;
        let wasteContainersLayer;
        let allContainersFeatureCollection = null; 
        let layerControl;
        let zoneContainerCounts = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ù„ÙƒÙ„ Ù…Ù†Ø·Ù‚Ø©

        const mapOptions = {
            zoomSnap: 0.5,
            center: [31.9045, 35.2045],
            zoom: 15.5, // ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø±Ø§Ù… Ø§Ù„Ù„Ù‡
        };

        const map = L.map("map", mapOptions);

        const darkTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // ----------------------------------------------------
        // 2. Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø³ØªØ§ÙŠÙ„Ø§Øª Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
        // ----------------------------------------------------

        // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª (Choropleth)
        function getZoneColor(count) {
            return count > 100 ? '#800026' : // Ø£Ø­Ù…Ø± Ø¯Ø§ÙƒÙ† Ø¬Ø¯Ø§Ù‹
                   count > 70  ? '#BD0026' : 
                   count > 40  ? '#E31A1C' : 
                   count > 20  ? '#FC4E2A' : 
                   count > 5   ? '#FD8D3C' : 
                                 '#FED976'; // Ø£ØµÙØ± ÙØ§ØªØ­ (Ø¹Ø¯Ø¯ Ù‚Ù„ÙŠÙ„)
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©ØŒ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
        function zoneStyle(feature) {
            const zoneName = feature.properties.NAME;
            const count = zoneContainerCounts[zoneName] || 0;
            return {
                fillColor: getZoneColor(count),
                fillOpacity: 0.7, // ØªÙ… Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø´ÙØ§ÙÙŠØ© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                color: 'white',
                weight: 1.0,
                opacity: 0.9
            };
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª
        function getContainerColor(wasteType) {
            switch (wasteType) {
                case 'Organic':
                    return 'green'; // Ø¹Ø¶ÙˆÙŠ
                case 'Inorganic':
                    return 'blue'; // ØºÙŠØ± Ø¹Ø¶ÙˆÙŠ / Ø¨Ù„Ø§Ø³ØªÙŠÙƒ
                case 'Glass':
                    return 'yellow'; // Ø²Ø¬Ø§Ø¬
                default:
                    return 'orange'; // Ø§ÙØªØ±Ø§Ø¶ÙŠ / ØºÙŠØ± Ù…Ø­Ø¯Ø¯
            }
        }
        
        // ----------------------------------------------------
        // 3. Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©: ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø·Ø¨Ù‚Ø§Øª
        // ----------------------------------------------------
        function updateLayerControl() {
            if (zonesLayer && wasteContainersLayer) {
                if (layerControl) {
                    map.removeControl(layerControl);
                }

                const baseLayers = {
                    "Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¯Ø§ÙƒÙ†Ø©": darkTileLayer
                };
                const overlays = {
                    "Ù…Ù†Ø§Ø·Ù‚ Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ (Ø­Ø³Ø¨ Ø§Ù„ÙƒØ«Ø§ÙØ©) ğŸ™ï¸": zonesLayer,
                    "Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù†ÙØ§ÙŠØ§Øª (Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹) ğŸ—‘ï¸": wasteContainersLayer
                };

                layerControl = L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);
            }
        }

        // ----------------------------------------------------
        // 4. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§
        // ----------------------------------------------------

        $.when(
            $.getJSON("RamallahZones.json"),
            $.getJSON("wasteContainer.json")
        ).done(function(zonesResponse, containersResponse) {
            const RZ = zonesResponse[0];
            const WC = containersResponse[0];

            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ù„Ù€ FeatureCollection Ù„Ù€ Turf.js
            allContainersFeatureCollection = turf.featureCollection(WC.features);

            // **Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ù„ÙƒÙ„ Ù…Ù†Ø·Ù‚Ø©**
            RZ.features.forEach(zoneFeature => {
                const zonePolygon = turf.feature(zoneFeature.geometry);
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… turf.pointsWithinPolygon Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¶Ù„Ø¹
                const pointsInZone = turf.pointsWithinPolygon(allContainersFeatureCollection, zonePolygon);
                const count = pointsInZone.features.length;
                zoneContainerCounts[zoneFeature.properties.NAME] = count;
                zoneFeature.properties.containerCount = count; // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø§ØµÙŠØ© Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§
            });

            // **Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ (Zones Layer) Ù…Ø¹ Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ**
            zonesLayer = L.geoJson(RZ, {
                style: zoneStyle, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                onEachFeature: function(feature, layer) {
                    const count = feature.properties.containerCount;
                    
                    // ØªØ­Ø³ÙŠÙ† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù€ Popup
                    const popupContent = `
                        <h4>ğŸ“ Ù…Ù†Ø·Ù‚Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</h4>
                        <strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${feature.properties.NAME || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}<br>
                        <hr style="margin: 5px 0;">
                        <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„ÙƒÙ„ÙŠ:</strong> <span style="font-weight: bold; color: ${getZoneColor(count)}; font-size: 1.1em;">${count}</span>
                    `;
                    layer.bindPopup(popupContent);

                    // ØªØ£Ø«ÙŠØ± Ø§Ù„ØªÙ…ÙŠÙŠØ² ÙˆØ§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø§Ù„Ù…Ø§ÙˆØ³
                    layer.on({
                        mouseover: function(e) {
                            layer.setStyle({
                                weight: 3,
                                color: '#1abc9c', // Ù„ÙˆÙ† Ø­Ø¯ÙˆØ¯ Ù…Ù…ÙŠØ²
                                fillOpacity: 0.9
                            });
                            layer.openTooltip();
                        },
                        mouseout: function(e) {
                            zonesLayer.resetStyle(layer);
                        },
                        click: function(e) {
                            map.fitBounds(layer.getBounds()); // Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
                        }
                    });

                    // Tooltip ÙŠØ¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
                    layer.bindTooltip(feature.properties.NAME, {
                        permanent: false,
                        direction: 'center',
                        className: 'zone-tooltip'
                    });
                }
            });
            zonesLayer.addTo(map);

            // **Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª (Containers Layer) Ù…Ø¹ Ø³ØªØ§ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹**
            wasteContainersLayer = L.geoJson(WC, {
                pointToLayer: function(feature, latlng) {
                    const containerType = feature.properties.TYPE_OF_WA || 'Unknown';
                    const color = getContainerColor(containerType);
                    
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙŠÙ‚ÙˆÙ†Ø© (Marker) Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ù„ØªÙ…ÙŠÙŠØ² Ø£ÙØ¶Ù„
                    return L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: color, 
                        color: 'black',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                },
                onEachFeature: function(feature, layer) {
                    const content = `
                        <strong>ğŸ—‘ï¸ Ù†ÙˆØ¹ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª:</strong> ${feature.properties.TYPE_OF_WA || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}<br>
                        <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${feature.properties.STATUS || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
                    `;
                    layer.bindPopup(content);
                }
            });
            wasteContainersLayer.addTo(map);
            
            // **Ø§Ù„Ø®Ø·ÙˆØ© 4: ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø·Ø¨Ù‚Ø§Øª**
            updateLayerControl();

        }).fail(function() {
            console.error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª GeoJSON. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ wasteContainer.json Ùˆ RamallahZones.json ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­.");
            alert("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„ÙØ§Øª GeoJSON Ø§Ù„ØµØ­ÙŠØ­Ø©.");
        });
    </script>
</body>
</html>
