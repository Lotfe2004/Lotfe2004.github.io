<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ Ramallah Schools Project</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// =======================
// 1ï¸âƒ£ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
// =======================
var map = L.map("map").setView([31.9, 35.2], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

// =======================
// 2ï¸âƒ£ Layers
// =======================
var settlementsLayer, schoolsLayer, coloniesLayer;
var proposedLayer = L.layerGroup();

var roadsLayer, hospitalsLayer, clinicsLayer, wellsLayer;
var wadisLayer, naturalLayer, militaryLayer, outpostsLayer, quarriesLayer;

// =======================
// 3ï¸âƒ£ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª
// =======================
fetch("tgmooat.json")
.then(r => r.json())
.then(data => {

  settlementsLayer = L.geoJSON(data, {
    style: {
      color: "#333",
      weight: 1,
      fillColor: "#ddd",
      fillOpacity: 0.4
    }
  }).addTo(map);

  map.fitBounds(settlementsLayer.getBounds());
  loadSchools();
});

// =======================
// 4ï¸âƒ£ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ + Ø§Ù„ØªØ­Ù„ÙŠÙ„
// =======================
function loadSchools(){
fetch("Ramallah_Schools.json")
.then(r => r.json())
.then(data => {

  schoolsLayer = L.geoJSON(data, {
    pointToLayer: (f, latlng) =>
      L.circleMarker(latlng, {
        radius: 5,
        color: "blue",
        fillOpacity: 0.9
      }).bindPopup("<b>Ù…Ø¯Ø±Ø³Ø©</b>")
  }).addTo(map);

  analyze(data);
});
}

function analyze(schoolsData){

settlementsLayer.eachLayer(layer => {

  let count = 0;
  schoolsData.features.forEach(s =>
    turf.booleanPointInPolygon(s, layer.feature) && count++
  );

  let p = layer.feature.properties || {};
  let name = p["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"] || p["NAME"] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  let pop = p["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || p["population"] || 0;

  let needed = Math.ceil(pop / 3000);
  let deficit = needed - count;

  let color = deficit > 0 ? "#e74c3c" : "#2ecc71";

  if (deficit > 0){
    let c = turf.centroid(layer.feature);
    L.marker([c.geometry.coordinates[1], c.geometry.coordinates[0]])
    .bindPopup(
      "<b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­</b><br>" +
      "Ø§Ù„ØªØ¬Ù…Ø¹: " + name + "<br>" +
      "Ø³Ø¹Ø± ØªÙ‚Ø±ÙŠØ¨ÙŠ: 600000 $"
    ).addTo(proposedLayer);
  }

  layer.setStyle({ fillColor: color, fillOpacity: 0.6 });

  layer.bindPopup(
    "<b>ØªØ¬Ù…Ø¹ Ø³ÙƒÙ†ÙŠ</b><hr>" +
    "Ø§Ù„Ø§Ø³Ù…: " + name + "<br>" +
    "Ø§Ù„Ø³ÙƒØ§Ù†: " + pop + "<br>" +
    "Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: " + count + "<br>" +
    "Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: " + needed
  );
});

proposedLayer.addTo(map);
loadOtherLayers();
}

// =======================
// 5ï¸âƒ£ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù„ÙŠØ±Ø§Øª (Ø¹Ø±Ø¶ ÙÙ‚Ø·)
// =======================
function loadOtherLayers(){

simpleLayer("roads.json", {color:"#555"}, "Ø·Ø±Ù‚", l => roadsLayer = l);
simpleLayer("hospitals.geojson", {color:"red"}, "Ù…Ø³ØªØ´ÙÙ‰", l => hospitalsLayer = l);
simpleLayer("clinics.geojson", {color:"orange"}, "Ø¹ÙŠØ§Ø¯Ø©", l => clinicsLayer = l);
simpleLayer("Wells.geojson", {color:"blue"}, "Ø¨Ø¦Ø±", l => wellsLayer = l);
simpleLayer("wadis.geojson", {color:"#00bcd4"}, "ÙˆØ§Ø¯ÙŠ", l => wadisLayer = l);
simpleLayer("natural.json", {color:"green"}, "Ù…Ù†Ø·Ù‚Ø© Ø·Ø¨ÙŠØ¹ÙŠØ©", l => naturalLayer = l);
simpleLayer("military.geojson", {color:"black"}, "Ù…Ù†Ø·Ù‚Ø© Ø¹Ø³ÙƒØ±ÙŠØ©", l => militaryLayer = l);
simpleLayer("outposts.geojson", {color:"#9c27b0"}, "Ø¨Ø¤Ø±Ø©", l => outpostsLayer = l);
simpleLayer("quarries.geojson", {color:"#795548"}, "ÙƒØ³Ø§Ø±Ø©", l => quarriesLayer = l);

// Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª
fetch("settlements.geojson")
.then(r=>r.json())
.then(d=>{
  coloniesLayer = L.geoJSON(d,{
    style:{color:"red",weight:2,fillOpacity:0.3},
    onEachFeature:(f,l)=>l.bindPopup("<b>Ù…Ø³ØªÙˆØ·Ù†Ø©</b>")
  }).addTo(map);

  layerControl();
});
}

// =======================
// 6ï¸âƒ£ Ø¯Ø§Ù„Ø© Ø¹Ø§Ù…Ø© Ø¢Ù…Ù†Ø©
// =======================
function simpleLayer(file, style, label, callback){
fetch(file)
.then(r=>r.json())
.then(d=>{
  let l = L.geoJSON(d,{
    style: style,
    onEachFeature:(f,ly)=>ly.bindPopup("<b>"+label+"</b>")
  }).addTo(map);
  callback(l);
});
}

// =======================
// 7ï¸âƒ£ Layer Control
// =======================
function layerControl(){
L.control.layers(null,{
  "Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª": settlementsLayer,
  "Ø§Ù„Ù…Ø¯Ø§Ø±Ø³": schoolsLayer,
  "Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª": coloniesLayer,
  "Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù‚ØªØ±Ø­Ø©": proposedLayer,
  "Ø§Ù„Ø·Ø±Ù‚": roadsLayer,
  "Ù…Ø³ØªØ´ÙÙŠØ§Øª": hospitalsLayer,
  "Ø¹ÙŠØ§Ø¯Ø§Øª": clinicsLayer,
  "Ø¢Ø¨Ø§Ø±": wellsLayer,
  "Ø£ÙˆØ¯ÙŠØ©": wadisLayer,
  "Ù…Ù†Ø§Ø·Ù‚ Ø·Ø¨ÙŠØ¹ÙŠØ©": naturalLayer,
  "Ù…Ù†Ø§Ø·Ù‚ Ø¹Ø³ÙƒØ±ÙŠØ©": militaryLayer,
  "Ø¨Ø¤Ø±": outpostsLayer,
  "ÙƒØ³Ø§Ø±Ø§Øª": quarriesLayer
}).addTo(map);
}
</script>

</body>
</html>


