<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>School Deficit Analysis - Ramallah</title>

<link rel="stylesheet"
href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body { height:100%; margin:0; }
#map { height:100%; }
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
// =======================
// 1. MAP
// =======================
var map = L.map("map").setView([31.9, 35.2], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
}).addTo(map);

// =======================
// 2. LOAD DATA
// =======================
Promise.all([
    fetch("ramallah.json").then(r=>r.json()),
    fetch("Ramallah_Schools.json").then(r=>r.json())
]).then(([city, schools]) => {

    // حدود رام الله
    var cityLayer = L.geoJSON(city,{
        style:{color:"black",weight:3,fillOpacity:0}
    }).addTo(map);

    map.fitBounds(cityLayer.getBounds());

    // المدارس
    L.geoJSON(schools,{
        pointToLayer:(f,latlng)=>
            L.circleMarker(latlng,{
                radius:5,
                fillColor:"orange",
                color:"#000",
                weight:1,
                fillOpacity:0.9
            })
    }).addTo(map);

    // =======================
    // 3. GRID (500m)
    // =======================
    var bbox = turf.bbox(city);
    var grid = turf.squareGrid(bbox, 0.5, {units:"kilometers"});

    grid.features.forEach(cell => {

        // فقط المربعات داخل رام الله
        if(!turf.booleanIntersects(cell, city.features[0])) return;

        // حساب عدد المدارس داخل المربع
        var count = 0;
        schools.features.forEach(s => {
            if(turf.booleanPointInPolygon(s, cell)) count++;
        });

        cell.properties.schoolCount = count;

        var color = count === 0 ? "red" : "green";

        L.geoJSON(cell,{
            style:{
                color:color,
                weight:1,
                fillOpacity:0.4
            }
        }).addTo(map)
        .bindPopup(`
            <b>عدد المدارس:</b> ${count}<br>
            ${count === 0 ? "❌ منطقة نقص مدارس" : "✔️ منطقة مخدومة"}
        `);

        // =======================
        // 4. اقتراح مدرسة جديدة
        // =======================
        if(count === 0){
            var center = turf.centerOfMass(cell);

            var estimatedPrice = 300; // تقديري

            L.marker([
                center.geometry.coordinates[1],
                center.geometry.coordinates[0]
            ],{
                icon:L.icon({
                    iconUrl:"https://cdn-icons-png.flaticon.com/512/167/167707.png",
                    iconSize:[26,26]
                })
            }).addTo(map)
            .bindPopup(`
                <b>موقع مقترح لبناء مدرسة</b><br>
                سعر تقديري للأرض:<br>
                ${estimatedPrice} دينار / م²
            `);
        }

    });

});
</script>

</body>
</html>
