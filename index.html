<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Ramallah Waste Containers Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />

  <style>
    body {
      margin: 0px;
      height: 100%;
      width: 100%;
    }

    #map {
      position: absolute;
      width: 100%;
      top: 0px;
      bottom: 0;
    }
    
    /* Style for the filter dropdown control */
    .leaflet-control-filter {
        background-color: white;
        padding: 6px 10px;
        border-radius: 4px;
        box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        margin-right: 10px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        font-weight: bold;
    }
    .leaflet-control-filter strong {
        color: #333;
    }
    .leaflet-control-filter select {
        padding: 4px;
        border: 1px solid #ccc;
        border-radius: 3px;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <script>
    // ----------------------------------------------------
    // 1. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    // ----------------------------------------------------
    let zonesLayer;
    let wasteContainersLayer;
    let layerControl; 
    const allContainersData = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„ØºØ±Ø¶ Ø§Ù„ØªØµÙÙŠØ©

    // Map Initialization Options
    const mapOptions = {
      zoomSnap: 0.5,
      center: [31.9045, 35.2045], // Ù…Ø±ÙƒØ² Ø±Ø§Ù… Ø§Ù„Ù„Ù‡
      zoom: 16, 
    };

    const map = L.map("map", mapOptions);

    // Dark Tile Layer (Default Base Map)
    const darkTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(map);

    // ----------------------------------------------------
    // 2. Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªØµÙÙŠØ©
    // ----------------------------------------------------

    /**
     * Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø·Ø¨Ù‚Ø© Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù†ÙØ§ÙŠØ§Øª ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù„ÙˆÙ†ÙŠ ÙˆØ§Ù„Ù€ Popups.
     * ÙˆØªØ³ØªØ®Ø¯Ù… Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØµÙÙŠØ©.
     */
    function createContainersLayer(data) {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ù„Ù„ØªØµÙÙŠØ©)
        if (wasteContainersLayer && map.hasLayer(wasteContainersLayer)) {
            map.removeLayer(wasteContainersLayer);
        }

        wasteContainersLayer = L.geoJson(data, {
            pointToLayer: function(feature, latlng) {
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª
                let color;
                switch (feature.properties.TYPE_OF_WA) {
                    case 'Household':
                        color = '#E9573F'; // Ø£Ø­Ù…Ø± Ø¯Ø§ÙƒÙ† (Ù„Ù„Ù…Ù†Ø²Ù„ÙŠØ©)
                        break;
                    case 'Recycling':
                        color = '#4CAF50'; // Ø£Ø®Ø¶Ø± (Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±)
                        break;
                    case 'Plastics':
                        color = '#3F51B5'; // Ø£Ø²Ø±Ù‚ (Ù„Ù„Ø¨Ù„Ø§Ø³ØªÙŠÙƒ)
                        break;
                    default:
                        color = '#FBC02D'; // Ø£ØµÙØ± Ø°Ù‡Ø¨ÙŠ (Ù„ØºÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯)
                }
                
                return L.circleMarker(latlng, {
                    radius: 7, // Ø­Ø¬Ù… Ø£ÙƒØ¨Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹
                    fillColor: color,
                    color: color,
                    weight: 1.5,
                    opacity: 1,
                    fillOpacity: 0.85
                });
            },
            onEachFeature: function(feature, layer) {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Popups Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                const popupContent = `
                    <h4 style="margin: 5px 0; color: ${layer.options.fillColor}">ğŸ§º Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø§ÙˆÙŠØ©</h4>
                    <strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${feature.properties.TYPE_OF_WA || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}<br>
                    <strong>Ø§Ù„Ø³Ø¹Ø©:</strong> ${feature.properties.SIZE_IN_M3 || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} Ù…Â³
                `;
                layer.bindPopup(popupContent);
            }
        });
        
        // Ø£Ø¶Ù Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© 
        wasteContainersLayer.addTo(map);
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ù„ÙŠØ¹ÙƒØ³ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        updateLayerControl();
    }

    /**
     * Ø¯Ø§Ù„Ø© Ù„ØªØµÙÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø·Ø¨Ù‚Ø©.
     */
    function filterContainers(wasteType) {
        if (wasteType === 'All') {
            createContainersLayer(allContainersData);
        } else {
            const filteredFeatures = allContainersData.features.filter(feature => 
                feature.properties.TYPE_OF_WA === wasteType
            );
            const filteredGeoJson = {
                "type": "FeatureCollection",
                "features": filteredFeatures
            };
            createContainersLayer(filteredGeoJson);
        }
    }

    /**
     * Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø·Ø¨Ù‚Ø§Øª ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.
     */
    function updateLayerControl() {
        // ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø·Ø¨Ù‚Ø§Øª ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙƒÙ„ØªØ§ Ø§Ù„Ø·Ø¨Ù‚ØªÙŠÙ† Ø¬Ø§Ù‡Ø²ØªÙŠÙ†
        if (zonesLayer && wasteContainersLayer) {
            if (layerControl) {
                map.removeControl(layerControl);
            }

            const baseLayers = {
              "Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¯Ø§ÙƒÙ†Ø© (CARTO)": darkTileLayer
            };
            const overlays = {
              "Ù…Ù†Ø§Ø·Ù‚ Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ ğŸ™ï¸": zonesLayer,
              "Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù†ÙØ§ÙŠØ§Øª ğŸ—‘ï¸": wasteContainersLayer
            };

            layerControl = L.control.layers(baseLayers, overlays).addTo(map);
        }
    }
    
    /**
     * Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± ØªØ­ÙƒÙ… Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ù…Ø®ØµØµ (Dropdown).
     */
    function addFilterControl() {
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const wasteTypes = ['All']; 
        allContainersData.features.forEach(feature => {
            const type = feature.properties.TYPE_OF_WA;
            if (type && !wasteTypes.includes(type)) {
                wasteTypes.push(type);
            }
        });

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± ØªØ­ÙƒÙ… Leaflet Ù…Ø®ØµØµ
        const FilterControl = L.Control.extend({
            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'leaflet-control-filter');
                container.innerHTML = '<strong>ØªØµÙÙŠØ© Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª: </strong>';
                
                const select = L.Dom
