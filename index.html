<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Ramallah School Accessibility Analysis (Accessibility & Coverage)</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.8/dist/leaflet-search.min.css" />

    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
            width: 100%;
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø¬Ù…ÙŠÙ„ Ù„Ø²Ø± Ø§Ù„Ø¨Ø­Ø« */
        .leaflet-control-search .search-button {
            background-color: #007bff;
            color: #fff;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-search@3.0.8/dist/leaflet-search.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        const map = L.map('map', {
            center: [31.9019, 35.2043], // Ù…Ø±ÙƒØ² Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ
            zoom: 15,
            zoomSnap: 0.5
        });

        // Ø·Ø¨Ù‚Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© (Ù…Ù…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡Ø§ Ù„Ø£ÙŠ Ø®Ø±ÙŠØ·Ø© ØªÙØ¶Ù„Ù‡Ø§)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
        }).addTo(map);

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø·Ø¨Ù‚Ø§Øª
        const schoolsCluster = L.markerClusterGroup();
        const neighborhoodsLayer = L.geoJSON(null); // Ø·Ø¨Ù‚Ø© Ø§Ù„Ø£Ø­ÙŠØ§Ø¡
        const voronoiLayer = L.geoJSON(null); // Ø·Ø¨Ù‚Ø© ÙÙˆØ±ÙˆÙ†ÙˆÙŠ (Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù†ÙÙˆØ°)
        let schoolsData = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³

        // --- Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ù„ÙˆÙ† Ø§Ù„Ø£Ø­ÙŠØ§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙƒØ«Ø§ÙØ© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ---
        function getNeighborhoodStyle(feature) {
            const count = feature.properties.SCHOOL_COUNT || 0;
            let fillColor;

            if (count > 4) {
                fillColor = '#4CAF50'; // Ø£Ø®Ø¶Ø±: ØªØºØ·ÙŠØ© Ø¹Ø§Ù„ÙŠØ©
            } else if (count >= 2) {
                fillColor = '#FFC107'; // Ø£ØµÙØ±: ØªØºØ·ÙŠØ© Ù…ØªÙˆØ³Ø·Ø©
            } else {
                fillColor = '#F44336'; // Ø£Ø­Ù…Ø±: ÙØ¬ÙˆØ© (ØªØºØ·ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©)
            }

            return {
                fillColor: fillColor,
                fillOpacity: 0.6,
                color: '#fff',
                weight: 1.5,
                dashArray: '3'
            };
        }

        // --- ÙˆØ¸ÙŠÙØ© ØªÙØ§Ø¹Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙŠ ---
        const onEachNeighborhood = (feature, layer) => {
            const name = feature.properties.NAME || 'No Name';
            const count = feature.properties.SCHOOL_COUNT || 0;
            
            const popup = `
                <h4>Ø­ÙŠ: ${name}</h4>
                <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©: <b>${count}</b></p>
                <p>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØºØ·ÙŠØ©: <b>${count > 1 ? 'Ø¬ÙŠØ¯' : 'Ø¶Ø¹ÙŠÙ/ÙŠØ­ØªØ§Ø¬ Ù„ØªØ­Ø³ÙŠÙ†'}</b></p>
            `;
            layer.bindPopup(popup);
        };

        // --- Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø·Ø¨Ù‚Ø© Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„ÙƒÙ„Ø§Ø³ØªØ± ---
        $.getJSON('RamallahSchools.geojson').done(SC => {
            schoolsData = SC; // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Voronoi
            
            L.geoJSON(SC, {
                pointToLayer: (feature, latlng) => {
                    const icon = L.divIcon({
                        html: '<div style="color: #007bff; font-size: 24px;">ğŸ¢</div>', // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¬Ø°Ø§Ø¨Ø© Ù„Ù„Ù…Ø¯Ø±Ø³Ø©
                        className: 'custom-school-icon',
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    });
                    return L.marker(latlng, { icon: icon }).bindPopup(`<b>${feature.properties.NAME || 'Ù…Ø¯Ø±Ø³Ø©'}</b>`);
                }
            }).eachLayer(layer => schoolsCluster.addLayer(layer));

            map.addLayer(schoolsCluster);
            console.log("Schools data loaded and clustered.");

            // --- Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø­ÙŠØ§Ø¡ ÙˆØ¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (Count) ---
            $.getJSON('RamallahNeighborhoods.geojson').done(RZ => {
                const schoolPoints = turf.featureCollection(schoolsData.features);
                
                // Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø­ÙŠ
                RZ.features.forEach(zone => {
                    let count = 0;
                    schoolPoints.features.forEach(pt => {
                        if (turf.booleanPointInPolygon(pt, zone)) count++;
                    });
                    zone.properties.SCHOOL_COUNT = count;
                });

                // Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø§Ù„Ø£Ø­ÙŠØ§Ø¡ Ù„Ù„Ø®Ø±ÙŠØ·Ø©
                neighborhoodsLayer.addData(RZ);
                neighborhoodsLayer.eachLayer(layer => onEachNeighborhood(layer.feature, layer)); // Ø±Ø¨Ø· Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø§Øª
                map.addLayer(neighborhoodsLayer);
                console.log("Neighborhoods loaded and school count calculated.");

                // --- Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù†ÙÙˆØ° (Voronoi Polygons) Ù„Ù„Ù…Ø¯Ø§Ø±Ø³ ---
                try {
                    const bbox = turf.bbox(schoolPoints);
                    // Ù‚Ù… Ø¨ØªÙˆØ³ÙŠØ¹ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† ØªØºØ·ÙŠØ© ÙƒØ§Ù…Ù„Ø©
                    const voronoiPolygons = turf.voronoi(schoolPoints, { bbox: bbox });

                    voronoiLayer.addData(voronoiPolygons).setStyle({
                        fillColor: '#8E44AD', // Ù„ÙˆÙ† Ø¨Ù†ÙØ³Ø¬ÙŠ Ù„Ø·Ø¨Ù‚Ø© ÙÙˆØ±ÙˆÙ†ÙˆÙŠ
                        fillOpacity: 0.15,
                        color: '#8E44AD',
                        weight: 1
                    }).bindPopup(layer => `Ù…Ù†Ø·Ù‚Ø© Ù†ÙÙˆØ° Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: ${layer.feature.properties.NAME || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`);
                    
                    // Ù„Ø§ ØªØ¶ÙÙ‡Ø§ Ù„Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ Ø¨Ù„ Ø§Ø¬Ø¹Ù„Ù‡Ø§ Ø®ÙŠØ§Ø±Ø§Ù‹ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¨Ù‚Ø§Øª
                    console.log("Voronoi Polygons created.");

                } catch (e) {
                    console.error("Failed to generate Voronoi polygons:", e);
                }

                // --- Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø¯Ø§Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª ---
                const searchControl = new L.Control.Search({
                    layer: neighborhoodsLayer, // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø·Ø¨Ù‚Ø© Ø§Ù„Ø£Ø­ÙŠØ§Ø¡
                    propertyName: 'NAME',
                    marker: false,
                    textPlaceholder: 'Search Neighborhood...',
                    moveToLocation: function (layer, name, map) {
                        const centroid = turf.centroid(layer.feature).geometry.coordinates;
                        map.setView([centroid[1], centroid[0]], 17);
                        layer.openPopup();
                    }
                });
                map.addControl(searchControl);

                // Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø¨Ù‚Ø§Øª
                L.control.layers(null, {
                    'Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ø­ÙŠØ§Ø¡ (ÙƒØ«Ø§ÙØ© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³)': neighborhoodsLayer,
                    'Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù†ÙÙˆØ° (Voronoi)': voronoiLayer,
                    'Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ (Clustered)': schoolsCluster
                }).addTo(map);

            }); // Ù†Ù‡Ø§ÙŠØ© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø­ÙŠØ§Ø¡
        }); // Ù†Ù‡Ø§ÙŠØ© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
    </script>
</body>
</html>
