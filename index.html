<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ© â€“ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }
.header {
  position:absolute;
  top:0; left:0; right:0;
  background:#1e3d59;
  color:white;
  padding:10px;
  z-index:1000;
  text-align:center;
}
table { width:100%; border-collapse:collapse }
td { border:1px solid #ccc; padding:4px; font-size:12px }
</style>
</head>

<body>

<div class="header">
<h3>ØªØ­Ù„ÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø­Ø³Ø¨ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©</h3>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// ================= MAP =================
var map = L.map("map").setView([31.9,35.2],11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// ================= POPUP BUILDER =================
function buildPopup(obj){
  let h="<table>";
  for(let k in obj){
    h+=`<tr><td><b>${k}</b></td><td>${obj[k]}</td></tr>`;
  }
  h+="</table>";
  return h;
}

// ================= LOAD DATA =================
Promise.all([
 fetch("tgmooat.json").then(r=>r.json()),
 fetch("Ramallah_Schools.json").then(r=>r.json()),
 fetch("settlements.geojson").then(r=>r.json()),
 fetch("built_up.json").then(r=>r.json()),
 fetch("roads.json").then(r=>r.json())
]).then(init);

// ================= INIT =================
function init(data){

let tgmooat=data[0];
let schools=data[1];
let settlements=data[2];
let built=data[3];
let roads=data[4];

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª (Ù„Ù„ØªÙˆØ¶ÙŠØ­ ÙÙ‚Ø·)
L.geoJSON(settlements,{style:{color:"red"}}).addTo(map);

// ================= Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ =================
L.geoJSON(schools,{
 pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5,color:"blue",fillOpacity:0.8})
}).addTo(map);

// ================= Ø§Ù„Ø¨Ø­Ø« =================
L.Control.geocoder({defaultMarkGeocode:false})
.on("markgeocode",e=>map.fitBounds(e.geocode.bbox))
.addTo(map);

// ================= Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª + Ø§Ù„ØªØ­Ù„ÙŠÙ„ =================
L.geoJSON(tgmooat,{
 style:{color:"black",fillOpacity:0.15},
 onEachFeature:(feature, layer)=>{

   let pop = feature.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || 0;
   let needed = Math.ceil(pop / 3000);

   let count = schools.features.filter(s =>
     turf.booleanPointInPolygon(s, feature)
   ).length;

   let deficit = count < needed;

   let analysis = `
   <hr>
   <b>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</b><br>
   ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†: ${pop}<br>
   ğŸ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${count}<br>
   ğŸ“Š Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${needed}<br>
   âš ï¸ Ø§Ù„Ø­Ø§Ù„Ø©: ${deficit ? "ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ" : "Ù…ÙƒØªÙÙŠ"}
   `;

   if(deficit){
     let center = turf.centroid(feature);

     // Ø´Ø±Ø· Ø§Ù„Ø§Ø¨ØªØ¹Ø§Ø¯ Ø¹Ù† Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª
     let safe = true;
     settlements.features.forEach(s=>{
       if(turf.distance(center,s,{units:"kilometers"}) < 0.8){
         safe = false;
       }
     });

     if(safe){
       // ØªØ«Ù…ÙŠÙ† Ø§Ù„Ø£Ø±Ø¶
       let price = 100;
       if(turf.booleanPointInPolygon(center,built)) price += 30;
       price += 20;

       L.marker(
         [center.geometry.coordinates[1], center.geometry.coordinates[0]]
       ).addTo(map)
       .bindPopup(`
         <b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©</b><br>
         ğŸ’° ØªØ«Ù…ÙŠÙ† Ø§Ù„Ø£Ø±Ø¶: ${price} $ / Ù…Â²
       `);

       analysis += `
       <br>ğŸ—ï¸ ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª
       `;
     } else {
       analysis += `
       <br>âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù‚ØªØ±Ø§Ø­ Ù…ÙˆÙ‚Ø¹ Ø¨Ø³Ø¨Ø¨ Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª
       `;
     }
   }

   layer.bindPopup(
     "<b>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ù…Ø¹</b><hr>" +
     buildPopup(feature.properties) +
     analysis
   );
 }
}).addTo(map);

}
</script>

</body>
</html>
