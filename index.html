<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>ØªØ­Ù„ÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø­Ø³Ø¨ Ø§Ù„ØªØ¬Ù…Ø¹</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }
.header {
  position:absolute;
  top:0; left:0; right:0;
  background:#1e3d59;
  color:white;
  padding:10px;
  z-index:1000;
  text-align:center;
}
</style>
</head>

<body>

<div class="header">
<h3>ØªØ­Ù„ÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø­Ø³Ø¨ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©</h3>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// ================= MAP =================
var map = L.map("map").setView([31.9,35.2],11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// ================= LOAD DATA =================
Promise.all([
 fetch("tgmooat.json").then(r=>r.json()),
 fetch("Ramallah_Schools.json").then(r=>r.json()),
 fetch("settlements.geojson").then(r=>r.json()),
 fetch("built_up.json").then(r=>r.json())
]).then(init);

// ================= INIT =================
function init(data){

let tgmooat = data[0];
let schools = data[1];
let settlements = data[2];
let built = data[3];

// Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØªØ¬Ù…Ø¹
L.Control.geocoder({
  defaultMarkGeocode:false
}).on("markgeocode",function(e){
  map.fitBounds(e.geocode.bbox);
}).addTo(map);

// ================= Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª ÙÙ‚Ø· =================
L.geoJSON(tgmooat,{
 style:{color:"black",fillOpacity:0.2},
 onEachFeature:function(feature, layer){

   layer.on("click", function(){

     let pop = feature.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || 0;
     let needed = Math.ceil(pop / 3000);

     let schoolCount = schools.features.filter(s =>
       turf.booleanPointInPolygon(s, feature)
     ).length;

     let deficit = schoolCount < needed;

     let html = `
     <b>${feature.properties["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"]}</b><br>
     ğŸ‘¥ Ø§Ù„Ø³ÙƒØ§Ù†: ${pop}<br>
     ğŸ« Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${schoolCount}<br>
     ğŸ“Š Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${needed}<br>
     âš ï¸ Ø§Ù„Ø­Ø§Ù„Ø©: ${deficit ? "ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ" : "Ù…ÙƒØªÙÙŠ"}
     `;

     if(deficit){
       let center = turf.centroid(feature);

       // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø¹Ø¯ Ø¹Ù† Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª
       let safe = true;
       settlements.features.forEach(s=>{
         if(turf.distance(center,s,{units:"kilometers"}) < 1){
           safe = false;
         }
       });

       if(safe){
         let price = 100;
         if(turf.booleanPointInPolygon(center,built)) price += 40;

         L.marker(
           [center.geometry.coordinates[1], center.geometry.coordinates[0]]
         ).addTo(map);

         html += `
         <hr>
         ğŸ—ï¸ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ¬Ù…Ø¹<br>
         ğŸ’° ØªØ«Ù…ÙŠÙ† Ø§Ù„Ø£Ø±Ø¶: ${price} $ / Ù…Â²
         `;
       } else {
         html += `<br>âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆÙ‚Ø¹ Ø¢Ù…Ù† Ø¨Ø³Ø¨Ø¨ Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª`;
       }
     }

     layer.bindPopup(html).openPopup();
   });
 }
}).addTo(map);

map.fitBounds(L.geoJSON(tgmooat).getBounds());
}
</script>

</body>
</html>
