<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>ØªØ­Ù„ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ â€“ Ù…Ø­Ø§ÙØ¸Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// =======================
// 1ï¸âƒ£ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
// =======================
var map = L.map("map").setView([31.9, 35.2], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// =======================
// 2ï¸âƒ£ Icons
// =======================
var schoolIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/167/167707.png",
  iconSize: [25,25]
});

// =======================
// 3ï¸âƒ£ Layer Variables
// =======================
var settlementsLayer, schoolsLayer, proposedLayer = L.layerGroup();
var areaALayer, areaBLayer, areaCLayer;
var roadsLayer, wadisLayer, naturalLayer, militaryLayer;
var hospitalsLayer, clinicsLayer, wellsLayer;
var outpostsLayer, coloniesLayer, quarriesLayer;

// =======================
// 4ï¸âƒ£ Areas A / B / C
// =======================
fetch("area_A.geojson").then(r=>r.json()).then(d=>{
  areaALayer = L.geoJSON(d,{style:{color:"#4caf50",fillOpacity:0.2}}).addTo(map);
});

fetch("Area_B.geojson").then(r=>r.json()).then(d=>{
  areaBLayer = L.geoJSON(d,{style:{color:"#ffeb3b",fillOpacity:0.2}}).addTo(map);
});

var areaCData;
fetch("area_C (1).geojson").then(r=>r.json()).then(d=>{
  areaCData = d;
  areaCLayer = L.geoJSON(d,{style:{color:"#f44336",fillOpacity:0.2}}).addTo(map);
});

// =======================
// 5ï¸âƒ£ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª
// =======================
fetch("tgmooat.json").then(r=>r.json()).then(d=>{
  settlementsLayer = L.geoJSON(d,{
    style:{color:"#333",weight:1,fillColor:"#ddd",fillOpacity:0.4}
  }).addTo(map);

  map.fitBounds(settlementsLayer.getBounds());
  loadSchools();
});

// =======================
// 6ï¸âƒ£ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
// =======================
function loadSchools(){
fetch("Ramallah_Schools.json").then(r=>r.json()).then(data=>{
  schoolsLayer = L.geoJSON(data,{
    pointToLayer:(f,latlng)=>L.marker(latlng,{icon:schoolIcon})
      .bindPopup("<b>Ù…Ø¯Ø±Ø³Ø©</b>")
  }).addTo(map);

  analyze(data);
});
}

// =======================
// 7ï¸âƒ£ Ø§Ù„ØªØ­Ù„ÙŠÙ„ + Ù…Ù†Ø¹ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ ÙÙŠ Area C
// =======================
function analyze(schoolsData){

settlementsLayer.eachLayer(layer=>{

  let count = 0;
  schoolsData.features.forEach(s=>{
    if(turf.booleanPointInPolygon(s,layer.feature)) count++;
  });

  let p = layer.feature.properties || {};
  let name = p["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"] || p["NAME"] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  let pop  = p["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || 0;

  let needed = Math.ceil(pop/3000);
  let deficit = needed - count;

  let color = deficit>0 ? "#e74c3c" : "#2ecc71";

  if(deficit>0){
    let c = turf.centroid(layer.feature);
    let insideC = false;

    areaCData.features.forEach(ac=>{
      if(turf.booleanPointInPolygon(c,ac)) insideC = true;
    });

    if(!insideC){
      L.marker([c.geometry.coordinates[1],c.geometry.coordinates[0]])
      .bindPopup("<b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©</b><br>"+name)
      .addTo(proposedLayer);
    }
  }

  layer.setStyle({fillColor:color,fillOpacity:0.6});
  layer.bindPopup(
    "<b>ØªØ¬Ù…Ø¹ Ø³ÙƒÙ†ÙŠ</b><hr>"+
    "Ø§Ù„Ø§Ø³Ù…: "+name+"<br>"+
    "Ø§Ù„Ø³ÙƒØ§Ù†: "+pop+"<br>"+
    "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: "+count
  );
});

proposedLayer.addTo(map);
loadOtherLayers();
}

// =======================
// 8ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù„ÙŠØ±Ø§Øª (Ø¹Ø±Ø¶ ÙÙ‚Ø·)
// =======================
function loadOtherLayers(){

simple("roads.json",{style:{color:"#555",weight:3}},"Ø·Ø±ÙŠÙ‚",l=>roadsLayer=l);
simple("wadis.geojson",{style:{color:"#00bcd4"}},"ÙˆØ§Ø¯ÙŠ",l=>wadisLayer=l);
simple("natural.json",{style:{color:"green",fillOpacity:0.4}},"Ù…Ù†Ø·Ù‚Ø© Ø·Ø¨ÙŠØ¹ÙŠØ©",l=>naturalLayer=l);
simple("military.geojson",{style:{color:"black",fillOpacity:0.4}},"Ù…Ù†Ø·Ù‚Ø© Ø¹Ø³ÙƒØ±ÙŠØ©",l=>militaryLayer=l);
simple("quarries.geojson",{style:{color:"#795548",fillOpacity:0.5}},"ÙƒØ³Ø§Ø±Ø©",l=>quarriesLayer=l);

fetch("outposts.geojson").then(r=>r.json()).then(d=>{
  outpostsLayer = L.geoJSON(d,{
    pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
      radius:6,color:"#6a1b9a",fillOpacity:0.7
    }).bindPopup("<b>Ø¨Ø¤Ø±Ø©</b>")
  }).addTo(map);
});

fetch("settlements.geojson").then(r=>r.json()).then(d=>{
  coloniesLayer = L.geoJSON(d,{
    style:{color:"red",weight:2,fillOpacity:0.3}
  }).addTo(map);
  layerControl();
});
}

// =======================
// Helper
// =======================
function simple(file,opt,text,cb){
fetch(file).then(r=>r.json()).then(d=>{
  let l=L.geoJSON(d,opt).addTo(map);
  l.eachLayer(x=>x.bindPopup("<b>"+text+"</b>"));
  cb(l);
});
}

// =======================
// 9ï¸âƒ£ Legend
// =======================
function layerControl(){
L.control.layers(null,{
  "Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª":settlementsLayer,
  "Ø§Ù„Ù…Ø¯Ø§Ø±Ø³":schoolsLayer,
  "Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù‚ØªØ±Ø­Ø©":proposedLayer,
  "Area A":areaALayer,
  "Area B":areaBLayer,
  "Area C":areaCLayer,
  "Ø·Ø±Ù‚":roadsLayer,
  "Ø£ÙˆØ¯ÙŠØ©":wadisLayer,
  "Ù…Ù†Ø§Ø·Ù‚ Ø·Ø¨ÙŠØ¹ÙŠØ©":naturalLayer,
  "Ù…Ù†Ø§Ø·Ù‚ Ø¹Ø³ÙƒØ±ÙŠØ©":militaryLayer,
  "ÙƒØ³Ø§Ø±Ø§Øª":quarriesLayer,
  "Ø¨Ø¤Ø±":outpostsLayer,
  "Ù…Ø³ØªÙˆØ·Ù†Ø§Øª":coloniesLayer
}).addTo(map);
}
</script>

</body>
</html>
