<!DOCTYPE html>
<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8" />

  <title>Ramallah Waste Containers - Final Code</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />

  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <style>
    /* style the body */
    body {
      margin: 0px;
      height: 100%;
      width: 100%;
    }

    /* style the map */
    #map {
      position: absolute;
      width: 100%;
      top: 0px;
      bottom: 0;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <script>
    // ----------------------------------------------------
    // 1. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    // ----------------------------------------------------
    let zonesLayer; 
    let wasteContainersLayer;
    let allContainersFeatureCollection = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ù„Ù€ Turf
    let layerControl;

    // define map options
    const mapOptions = {
      zoomSnap: 0.5,
      center: [31.9045, 35.2045], 
      zoom: 17.5, 
    };

    // define the map with the options above
    const map = L.map("map", mapOptions);

    // Default Base Map
    const darkTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(map);

    // ----------------------------------------------------
    // 2. Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
    // ----------------------------------------------------

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø·Ø¨Ù‚Ø§Øª
    function updateLayerControl() {
        if (zonesLayer && wasteContainersLayer) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
            if (layerControl) {
                map.removeControl(layerControl);
            }

            const baseLayers = {
              "Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¯Ø§ÙƒÙ†Ø©": darkTileLayer
            };
            const overlays = {
              "Ù…Ù†Ø§Ø·Ù‚ Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ ğŸ™ï¸": zonesLayer,
              "Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù†ÙØ§ÙŠØ§Øª ğŸ—‘ï¸": wasteContainersLayer
            };

            layerControl = L.control.layers(baseLayers, overlays).addTo(map);
        }
    }

    // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
    function defaultZoneStyle(feature) {
        return {
            fillColor: "yellow",
            fillOpacity: 0.3,
            color: "yellow",
            weight: 1.0,
            opacity: 0.7
        };
    }
    
    // ----------------------------------------------------
    // 3. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    // ----------------------------------------------------

    // ØªØ­Ù…ÙŠÙ„ Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù†ÙØ§ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹
    $.getJSON("wasteContainer.json", function(WC) {
        // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª ÙÙŠ Ù…ØªØºÙŠØ± Turf.js Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„
        allContainersFeatureCollection = turf.featureCollection(WC.features);

        wasteContainersLayer = L.geoJson(WC, {
            pointToLayer: function(feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 5,
                    fillColor: "orange",
                    color: "orange",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            },
            onEachFeature: function(feature, layer) {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Popup Ù„Ø¹Ø±Ø¶ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
                const content = `<strong>Ù†ÙˆØ¹ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª:</strong> ${feature.properties.TYPE_OF_WA || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
                layer.bindPopup(content);
            }
        });
        wasteContainersLayer.addTo(map);

        // Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ§ØªØŒ Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
        loadZones();
        updateLayerControl();
    }).fail(function() {
        console.error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ wasteContainer.json");
    });

    // Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
    function loadZones() {
        $.getJSON("RamallahZones.json", function(RZ) {
            zonesLayer = L.geoJson(RZ, {
                style: defaultZoneStyle, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
                onEachFeature: function(feature, layer) {
                    
                    // ---------------------------------------------------
                    // **Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© 1: Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±**
                    // ---------------------------------------------------
                    layer.on('click', function(e) {
                        if (allContainersFeatureCollection) {
                            const zonePolygon = turf.feature(feature.geometry);
                            const pointsInZone = turf.pointsWithinPolygon(allContainersFeatureCollection, zonePolygon);
                            const count = pointsInZone.features.length;

                            const popupContent = `
                                <h4>ğŸ“ Ù…Ù†Ø·Ù‚Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</h4>
                                <strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${feature.properties.NAME || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}<br>
                                <hr style="margin: 5px 0;">
                                <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„ÙƒÙ„ÙŠ:</strong> <span style="font-weight: bold; color: green; font-size: 1.1em;">${count}</span>
                            `;
                            // ÙØªØ­ Popup Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
                            layer.bindPopup(popupContent).openPopup(e.latlng);
                        } else {
                            alert("Zone Name: " + feature.properties.NAME);
                        }
                    });

                    // ---------------------------------------------------
                    // **Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© 2: ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± ÙÙˆÙ‚Ù‡Ø§ (Hover Effect)**
                    // ---------------------------------------------------
                    layer.on('mouseover', function(e) {
                        layer.setStyle({
                            weight: 3,
                            color: '#FF0000', // Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ø³Ø§Ø·Ø¹ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ±
                            fillOpacity: 0.5 
                        });
                        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ù…Ù†Ø·Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ±
                        layer.openTooltip(); 
                    });

                    layer.on('mouseout', function(e) {
                        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø¨ØªØ¹Ø§Ø¯
                        zonesLayer.resetStyle(layer);
                    });

                    // Ø¥Ø¶Ø§ÙØ© Tooltip ÙŠØ¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± (Ù„Ø§ ÙŠØ­ØªØ§Ø¬ Ù„Ù†Ù‚Ø±)
                    layer.bindTooltip(feature.properties.NAME, { 
                        permanent: false, 
                        direction: 'center', 
                        className: 'zone-tooltip'
                    });
                    
                }
            });
            zonesLayer.addTo(map);
            updateLayerControl();
        }).fail(function() {
            console.error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ RamallahZones.json");
        });
    }
    
  </script>
</body>

</html>

