<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>تحليل وصول المدارس واحتياج الأحياء في رام الله</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.8/dist/leaflet-search.min.css" />

    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
            padding: 0;
            width: 100%;
        }
        .legend {
            line-height: 18px;
            color: #555;
            background: white;
            padding: 6px 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.8;
            border: 1px solid #ccc;
        }
        .info-panel {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet-search@3.0.8/dist/leaflet-search.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <script>
        const map = L.map('map', {
            center: [31.903, 35.205], 
            zoom: 15,
            zoomSnap: 0.5
        });

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
        }).addTo(map);

        const schoolsCluster = L.markerClusterGroup();
        const zonesLayer = L.geoJSON(null);
        let voronoiLayer = L.geoJSON(null);
        let nearestSchoolLine = null; // لتخزين خط المسافة الأقصر

        // ==========================================================
        // 1. وظيفة تصحيح Geometry (تتعامل مع Ramallah_Schools.json)
        // ==========================================================
        function fixSchoolGeometry(data) {
            if (!data || !data.features) return data;
            data.features = data.features.filter(feature => {
                if (feature.geometry === null && feature.properties.North && feature.properties.East) {
                    feature.geometry = {
                        type: "Point",
                        coordinates: [
                            parseFloat(feature.properties.East),
                            parseFloat(feature.properties.North)
                        ]
                    };
                    return true;
                }
                return feature.geometry !== null; 
            });
            return data;
        }

        // ==========================================================
        // 2. التنسيق والتحليل (Styling & Analysis)
        // ==========================================================

        // أ. التنسيق بناءً على تحليل إمكانية الوصول (Accessibility)
        function getZoneStyle(feature) {
            const distance = feature.properties.NEAREST_DISTANCE || Infinity; // بالعداد
            let fillColor;

            if (distance <= 500) {
                fillColor = '#1e7f3a'; // أخضر: وصول ممتاز (< 500م)
            } else if (distance <= 1000) {
                fillColor = '#ffc107'; // أصفر: وصول مقبول (500م - 1كم)
            } else {
                fillColor = '#c0392b'; // أحمر: وصول ضعيف (> 1كم)
            }

            return {
                fillColor: fillColor,
                fillOpacity: 0.6,
                color: '#fff',
                weight: 1.5,
                dashArray: '3'
            };
        }

        // ب. محتوى المنبثق (Popup) وتطبيق التحليل
        const onEachZone = (feature, layer) => {
            const name = feature.properties.NAME || 'حي غير مسمى';
            const count = feature.properties.SCHOOL_COUNT || 0;
            const distance = feature.properties.NEAREST_DISTANCE ? feature.properties.NEAREST_DISTANCE.toFixed(0) : 'غير معروف';
            const ratio = feature.properties.POP_PER_SCHOOL ? feature.properties.POP_PER_SCHOOL.toFixed(0) : 'غير معروف';
            const nearestSchoolName = feature.properties.NEAREST_SCHOOL_NAME || '---';

            let accessStatus = 'ممتاز';
            if (distance > 1000) accessStatus = 'ضعيف - يحتاج لنقل مدرسي';
            else if (distance > 500) accessStatus = 'مقبول';

            let capacityStatus = 'جيد';
            if (ratio > 5000) capacityStatus = 'اكتظاظ شديد';
            else if (ratio > 2500) capacityStatus = 'اكتظاظ متوسط';

            const popup = `
                <h4><b style="color:#007bff;">${name}</b></h4>
                <hr style="margin: 5px 0;">
                
                <p><b>تحليل الوصول:</b></p>
                <ul>
                    <li>أقرب مدرسة: <b>${nearestSchoolName}</b></li>
                    <li>مسافة الوصول: <b>${distance} متر</b></li>
                    <li>حالة الوصول: <b style="color:${getZoneStyle(feature).fillColor};">${accessStatus}</b></li>
                </ul>
                
                <p><b>تحليل القدرة الاستيعابية:</b></p>
                <ul>
                    <li>عدد المدارس الداخلية: <b>${count}</b></li>
                    <li>نسبة السكان لكل مدرسة: <b>${ratio} شخص</b></li>
                    <li>حالة الاكتظاظ: <b>${capacityStatus}</b></li>
                </ul>
            `;
            
            layer.bindPopup(popup);

            // وظيفة رسم خط المسافة الأقصر عند النقر
            layer.on('click', function(e) {
                if (nearestSchoolLine) map.removeLayer(nearestSchoolLine);
                
                if (feature.properties.NEAREST_SCHOOL_COORDS) {
                    const centroidCoords = turf.getCoord(turf.centroid(feature));
                    const schoolCoords = feature.properties.NEAREST_SCHOOL_COORDS;
                    
                    const line = L.polyline([
                        [centroidCoords[1], centroidCoords[0]], // مركز الحي
                        [schoolCoords[1], schoolCoords[0]]      // أقرب مدرسة
                    ], {
                        color: 'blue',
                        weight: 3,
                        dashArray: '5, 5'
                    });
                    
                    nearestSchoolLine = line.addTo(map);
                }
            });
        };

        // ==========================================================
        // 3. تحميل وتحليل البيانات
        // ==========================================================

        $.when(
            $.getJSON('Ramallah_Schools.json'),
            $.getJSON('RamallahZones.json')
        ).done((schoolsResponse, zonesResponse) => {
            
            let schoolsData = fixSchoolGeometry(schoolsResponse[0]);
            const zonesData = zonesResponse[0];

            const schoolPoints = turf.featureCollection(schoolsData.features);
            const zonePolygons = zonesData.features;

            // بيانات سكانية تقديرية (لتحليل الاكتظاظ - يجب شرح هذا للدكتورة)
            const simulatedPopulation = [4500, 7000, 2000, 15000, 3000, 6000, 4000, 1800, 8000, 500];
            
            zonePolygons.forEach((zone, index) => {
                const zoneCentroid = turf.centroid(zone);
                let count = 0;
                
                // 1. تحليل كثافة المدارس
                schoolPoints.features.forEach(pt => {
                    if (turf.booleanPointInPolygon(pt, zone)) count++;
                });
                zone.properties.SCHOOL_COUNT = count;

                // 2. تحليل الوصول (المسافة إلى أقرب مدرسة)
                const nearest = turf.nearestPoint(zoneCentroid, schoolPoints);
                const distanceInKm = turf.distance(zoneCentroid, nearest);
                zone.properties.NEAREST_DISTANCE = distanceInKm * 1000; // بالعداد
                zone.properties.NEAREST_SCHOOL_NAME = nearest.properties.Arabic_Sch || nearest.properties.English_Sc;
                zone.properties.NEAREST_SCHOOL_COORDS = turf.getCoord(nearest);

                // 3. تحليل الاكتظاظ (Capacity Analysis)
                // يتم استخدام بيانات تقديرية
                const pop = simulatedPopulation[index % simulatedPopulation.length] * 1.5; // توزيع السكان
                zone.properties.POPULATION = pop; 
                
                if (count > 0) {
                    zone.properties.POP_PER_SCHOOL = pop / count;
                } else {
                    zone.properties.POP_PER_SCHOOL = pop / 0.5; // قيمة عالية للإشارة للاكتظاظ/الحاجة
                }
            });

            // ------------------------------------
            // إضافة الطبقات للخريطة
            // ------------------------------------

            // 1. طبقة المدارس
            L.geoJSON(schoolPoints, {
                pointToLayer: (feature, latlng) => {
                    const schoolName = feature.properties.Arabic_Sch || feature.properties.English_Sc;
                    return L.marker(latlng).bindPopup(`<b>${schoolName}</b>`);
                }
            }).eachLayer(layer => schoolsCluster.addLayer(layer));
            
            map.addLayer(schoolsCluster);


            // 2. طبقة الأحياء (تحليل الوصول هو أساس التلوين)
            zonesLayer.addData(zonesData).setStyle(getZoneStyle);
            zonesLayer.eachLayer(onEachZone);
            map.addLayer(zonesLayer);


            // 3. إنشاء مناطق فورونوي (Voronoi Polygons)
            try {
                const bbox = turf.bbox(schoolPoints);
                const voronoiPolygons = turf.voronoi(schoolPoints, { bbox: bbox });

                voronoiLayer = L.geoJSON(voronoiPolygons, {
                    style: {
                        fillColor: '#8E44AD',
                        fillOpacity: 0.15,
                        color: '#8E44AD',
                        weight: 1
                    },
                    onEachFeature: (feature, layer) => {
                        const name = feature.properties.Arabic_Sch || feature.properties.English_Sc || 'مدرسة غير معروفة';
                        layer.bindPopup(`منطقة النفوذ الأقرب للمدرسة: <b>${name}</b>`);
                    }
                });
            } catch (e) {
                console.error("فشل في إنشاء مضلعات فورونوي:", e);
            }


            // ------------------------------------
            // إعداد أدوات التحكم
            // ------------------------------------

            const searchControl = new L.Control.Search({
                layer: zonesLayer,
                propertyName: 'NAME',
                marker: false,
                textPlaceholder: 'البحث عن حي...',
                moveToLocation: function (layer, name, map) {
                    const bounds = layer.getBounds();
                    map.fitBounds(bounds);
                    layer.openPopup();
                }
            });
            map.addControl(searchControl);

            L.control.layers(null, {
                'حدود الأحياء (تحليل الوصول)': zonesLayer,
                'مناطق النفوذ التعليمي (فورونوي)': voronoiLayer,
                'مواقع المدارس': schoolsCluster
            }).addTo(map);

            // إضافة وسيلة الإيضاح (Legend)
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'info legend');
                const grades = ['وصول ممتاز (< 500م)', 'وصول مقبول (500م - 1كم)', 'وصول ضعيف (> 1كم)'];
                const colors = ['#1e7f3a', '#ffc107', '#c0392b'];

                div.innerHTML += '<b>مؤشر الوصول للمدرسة (مشي)</b><br>';
                for (let i = 0; i < colors.length; i++) {
                    div.innerHTML +=
                        '<i style="background:' + colors[i] + '"></i> ' + grades[i] + '<br>';
                }
                div.innerHTML += '<hr style="margin: 5px 0;">'
                div.innerHTML += '<i style="background:blue; opacity: 1; border: none; height: 3px;"></i> خط المسافة الأقصر (انقر على الحي)';
                return div;
            };
            legend.addTo(map);

        }).fail((err) => {
            console.error("فشل في تحميل أحد ملفات GeoJSON. تأكد من وجود الملفات في نفس المجلد.", err);
            alert("خطأ: يرجى التأكد من وجود ملفات Ramallah_Schools.json و RamallahZones.json في نفس المجلد.");
        });
    </script>
</body>
</html>
