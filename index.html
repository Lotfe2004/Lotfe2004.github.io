<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ Decision Support System for Schools</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }

.header {
  position:absolute;
  top:0; left:0; right:0;
  background:#1e3d59;
  color:white;
  padding:10px;
  z-index:1000;
  text-align:center;
}

.legend {
  position:absolute;
  bottom:20px;
  right:20px;
  background:white;
  padding:10px;
  font-size:13px;
  z-index:1000;
}
</style>
</head>

<body>

<div class="header">
<h3>Decision Support System Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ â€“ Ù…Ø­Ø§ÙØ¸Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</h3>
</div>

<div id="map"></div>

<div class="legend">
<b>Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©</b><br>
ğŸŸ¢ Ù…ÙƒØªÙÙŠ<br>
ğŸ”´ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ Ù…Ø¯Ø§Ø±Ø³
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// ================= MAP =================
var map = L.map("map").setView([31.9, 35.2], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// Pane Ù„Ù„ØªØ¬Ù…Ø¹Ø§Øª (ØªØ­Øª Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª)
map.createPane("tgPane");
map.getPane("tgPane").style.zIndex = 200;

// ================= LOAD DATA =================
Promise.all([
 fetch("tgmooat.json").then(r=>r.json()),
 fetch("Ramallah_Schools.json").then(r=>r.json()),
 fetch("roads.json").then(r=>r.json()),
 fetch("built_up.json").then(r=>r.json()),
 fetch("settlements.geojson").then(r=>r.json()),
 fetch("outposts.geojson").then(r=>r.json()),
 fetch("military.geojson").then(r=>r.json()),
 fetch("wadis.geojson").then(r=>r.json()),
 fetch("quarries.geojson").then(r=>r.json()),
 fetch("natural.json").then(r=>r.json()),
 fetch("Wells.geojson").then(r=>r.json()),
 fetch("clinics.geojson").then(r=>r.json()),
 fetch("hospitals.geojson").then(r=>r.json())
]).then(init);

// ================= INIT =================
function init(d){

let tgmooat=d[0], schools=d[1], roads=d[2], built=d[3];
let settlements=d[4], outposts=d[5], military=d[6];
let wadis=d[7], quarries=d[8], natural=d[9];
let wells=d[10], clinics=d[11], hospitals=d[12];

// ===== DISPLAY ALL LAYERS =====
L.geoJSON(built,{style:{color:"#999",fillOpacity:0.3}}).addTo(map);
L.geoJSON(roads,{style:{color:"orange"}}).addTo(map);
L.geoJSON(settlements,{style:{color:"red",fillOpacity:0.4}}).addTo(map);
L.geoJSON(outposts,{style:{color:"darkred"}}).addTo(map);
L.geoJSON(military,{style:{color:"black"}}).addTo(map);
L.geoJSON(wadis,{style:{color:"blue"}}).addTo(map);
L.geoJSON(quarries,{style:{color:"brown"}}).addTo(map);
L.geoJSON(natural,{style:{color:"green"}}).addTo(map);

L.geoJSON(wells,{pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:4,color:"cyan"})}).addTo(map);
L.geoJSON(clinics,{pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5,color:"purple"})}).addTo(map);
L.geoJSON(hospitals,{pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:6,color:"darkblue"})}).addTo(map);

L.geoJSON(schools,{
 pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5,color:"blue",fillOpacity:0.8})
}).addTo(map);

// ===== SEARCH =====
L.Control.geocoder({defaultMarkGeocode:false})
.on("markgeocode",e=>map.fitBounds(e.geocode.bbox))
.addTo(map);

// ===== MAIN ANALYSIS: TGMO3AT =====
let tgLayer = L.geoJSON(tgmooat,{
 pane:"tgPane",

 style:f=>{
   let pop=f.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"]||0;
   let need=Math.ceil(pop/3000);
   let cnt=schools.features.filter(s=>turf.booleanPointInPolygon(s,f)).length;
   return {
     color:"black",
     fillOpacity:0.25,
     fillColor: cnt<need ? "red" : "green"
   };
 },

 onEachFeature:(f,l)=>{
   let pop=f.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"]||0;
   let need=Math.ceil(pop/3000);
   let cnt=schools.features.filter(s=>turf.booleanPointInPolygon(s,f)).length;
   let deficit=cnt<need;

   let html=`
   <b>${f.properties["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"]}</b><br>
   ğŸ‘¥ Ø§Ù„Ø³ÙƒØ§Ù†: ${pop}<br>
   ğŸ« Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${cnt}<br>
   ğŸ“Š Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${need}<br>
   âš ï¸ Ø§Ù„Ø­Ø§Ù„Ø©: ${deficit?"Ù†Ù‚Øµ":"Ù…ÙƒØªÙÙŠ"}
   `;

   if(deficit){
     let c=turf.centroid(f);

     let farSet=[settlements,outposts].every(g =>
       g.features.every(s=>turf.distance(c,s,{units:"kilometers"})>0.8)
     );

     let safe=[military,wadis,quarries,natural].every(g =>
       g.features.every(x=>!turf.booleanPointInPolygon(c,x))
     );

     let insideBuilt=turf.booleanPointInPolygon(c,built);
     let nearRoad=roads.features.some(r=>turf.distance(c,r,{units:"kilometers"})<0.5);
     let nearService=[wells,clinics,hospitals].some(g =>
       g.features.some(x=>turf.distance(c,x,{units:"kilometers"})<1)
     );

     let suitable=farSet && safe && insideBuilt && nearRoad;

     let price=100;
     if(insideBuilt) price+=30;
     if(nearRoad) price+=20;
     if(nearService) price+=20;
     if(suitable) price+=20;
     if(!farSet) price-=50;

     L.marker([c.geometry.coordinates[1],c.geometry.coordinates[0]])
      .addTo(map)
      .bindPopup(`
       <b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©</b><br>
       ğŸ§­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${suitable?"Ù…Ù†Ø§Ø³Ø¨":"ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨"}<br>
       ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø£Ø±Ø¶: ${price} $ / Ù…Â²
      `);

     html+=`
     <hr>
     ğŸ§­ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${suitable?"Ù…Ù†Ø§Ø³Ø¨":"ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨"}<br>
     ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ: ${price} $ / Ù…Â²
     `;
   }

   l.bindPopup(html);
 }
}).addTo(map);

map.fitBounds(tgLayer.getBounds());
}
</script>

</body>
</html>
