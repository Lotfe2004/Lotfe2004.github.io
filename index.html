<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© â€“ Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<style>
body { margin:0; font-family:Arial }
#map { height: 90vh }
#header {
  background:#1e3d59; color:white; padding:10px; text-align:center
}
#search { width:250px; padding:6px }
</style>
</head>

<body>

<div id="header">
  <h2>ØªØ­Ù„ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ÙˆØ§Ù‚ØªØ±Ø§Ø­ Ù…ÙˆØ§Ù‚Ø¹ Ø¬Ø¯ÙŠØ¯Ø© â€“ Ù…Ø­Ø§ÙØ¸Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</h2>
  <input id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ØªØ¬Ù…Ø¹ Ø³ÙƒÙ†ÙŠ">
</div>

<div id="map"></div>

<script>
// ================== Map ==================
var map = L.map('map').setView([31.9,35.2],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// ================== Global Data ==================
var schools, settlements, builtUp, roads, settlementsIL, military, wadis;
var proposedLayer;

// ================== Load Data ==================
Promise.all([
  fetch('Ramallah_Schools.json').then(r=>r.json()),
  fetch('settlements.geojson').then(r=>r.json()),
  fetch('built_up.json').then(r=>r.json()),
  fetch('roads.json').then(r=>r.json()),
  fetch('settlementsIL.geojson').then(r=>r.json()),
  fetch('military.geojson').then(r=>r.json()),
  fetch('wadis.geojson').then(r=>r.json())
]).then(data=>{
  schools=data[0];
  settlements=data[1];
  builtUp=data[2];
  roads=data[3];
  settlementsIL=data[4];
  military=data[5];
  wadis=data[6];
  drawMap();
});

// ================== Draw ==================
function drawMap(){

  // Schools
  var schoolLayer = L.geoJSON(schools,{
    pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5,color:'red',fillOpacity:0.8})
  }).addTo(map);

  // Settlements
  var settlementLayer = L.geoJSON(settlements,{
    style:{color:'blue',fillOpacity:0.1},
    onEachFeature:(f,l)=>{
      l.on('click',()=>analyze(f,l));
    }
  }).addTo(map);

  map.fitBounds(settlementLayer.getBounds());

  // Layers control
  L.control.layers(null,{
    "Ø§Ù„Ù…Ø¯Ø§Ø±Ø³":schoolLayer,
    "Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©":settlementLayer
  }).addTo(map);

  // Search
  document.getElementById("search").addEventListener("keyup",e=>{
    let v=e.target.value.toLowerCase();
    settlementLayer.eachLayer(l=>{
      if(l.feature.properties.name.toLowerCase().includes(v)){
        map.fitBounds(l.getBounds());
        l.fire('click');
      }
    });
  });
}

// ================== Analysis ==================
function analyze(feature, layer){

  // Count schools
  let count=0;
  schools.features.forEach(s=>{
    if(turf.booleanPointInPolygon(s,feature)) count++;
  });

  let population = feature.properties.population || 0;
  let needed = Math.ceil(population / 3000);
  let deficit = needed - count;

  let status = deficit>0 ? "âŒ ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ" : "âœ… ÙƒØ§ÙÙ";

  let popup = `
  <b>${feature.properties.name}</b><br>
  ğŸ‘¥ Ø§Ù„Ø³ÙƒØ§Ù†: ${population}<br>
  ğŸ« Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${count}<br>
  ğŸ“Š Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬: ${needed}<br>
  âš ï¸ Ø§Ù„Ø­Ø§Ù„Ø©: ${status}
  `;

  // If deficit â†’ propose land
  if(deficit>0){
    let centroid = turf.centroid(feature);

    // Avoid constraints
    if(
      !turf.booleanIntersects(centroid, settlementsIL) &&
      !turf.booleanIntersects(centroid, military) &&
      !turf.booleanIntersects(centroid, wadis)
    ){
      if(proposedLayer) map.removeLayer(proposedLayer);

      // Land price estimation
      let price = 500;
      if(turf.booleanIntersects(centroid,builtUp)) price+=300;
      if(turf.distance(centroid,roads,{units:'kilometers'})<0.5) price+=200;

      proposedLayer = L.geoJSON(centroid,{
        pointToLayer:(f,ll)=>L.marker(ll)
      }).addTo(map);

      popup+=`
      <hr>
      ğŸ—ï¸ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©<br>
      ğŸ’° Ø³Ø¹Ø± ØªÙ‚Ø¯ÙŠØ±ÙŠ Ù„Ù„Ø£Ø±Ø¶: ${price}$ / Ù…Â²
      `;
    }
  }

  layer.bindPopup(popup).openPopup();
}
</script>

</body>
</html>
