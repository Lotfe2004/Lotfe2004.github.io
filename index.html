<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ Ramallah Schools Project</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø«Ù„Ø« Ù„Ù„ÙƒØ³Ø§Ø±Ø§Øª */
.quarry-icon {
  width: 0;
  height: 0;
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-bottom: 18px solid #5d4037;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// =======================
// 1ï¸âƒ£ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
// =======================
var map = L.map("map").setView([31.9, 35.2], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// =======================
// 2ï¸âƒ£ Icons
// =======================
var schoolIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/167/167707.png",
  iconSize: [25,25]
});

var hospitalIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/2967/2967350.png",
  iconSize: [25,25]
});

var clinicIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/4320/4320337.png",
  iconSize: [22,22]
});

var wellIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
  iconSize: [22,22]
});

// Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙƒØ³Ø§Ø±Ø© (Ù…Ø«Ù„Ø«)
var quarryIcon = L.divIcon({
  className: "quarry-icon",
  iconSize: [20,18]
});

// =======================
// 3ï¸âƒ£ Layers
// =======================
var settlementsLayer, schoolsLayer, coloniesLayer;
var roadsLayer, hospitalsLayer, clinicsLayer, wellsLayer;
var wadisLayer, naturalLayer, militaryLayer, outpostsLayer, quarriesLayer;
var proposedLayer = L.layerGroup();

// =======================
// 4ï¸âƒ£ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª
// =======================
fetch("tgmooat.json")
.then(r=>r.json())
.then(d=>{
  settlementsLayer = L.geoJSON(d,{
    style:{color:"#333",weight:1,fillColor:"#ddd",fillOpacity:0.4}
  }).addTo(map);

  map.fitBounds(settlementsLayer.getBounds());
  loadSchools();
});

// =======================
// 5ï¸âƒ£ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ + Ø§Ù„ØªØ­Ù„ÙŠÙ„
// =======================
function loadSchools(){
fetch("Ramallah_Schools.json")
.then(r=>r.json())
.then(d=>{
  schoolsLayer = L.geoJSON(d,{
    pointToLayer:(f,latlng)=>L.marker(latlng,{icon:schoolIcon})
  }).addTo(map);

  analyze(d);
});
}

function analyze(schoolsData){
settlementsLayer.eachLayer(layer=>{

  let count=0;
  schoolsData.features.forEach(s=>{
    if(turf.booleanPointInPolygon(s,layer.feature)) count++;
  });

  let p=layer.feature.properties||{};
  let name=p["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"]||p["NAME"]||"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  let pop=p["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"]||p["population"]||0;

  let needed=Math.ceil(pop/3000);
  let deficit=needed-count;

  let color=deficit>0?"#e74c3c":"#2ecc71";

  if(deficit>0){
    let c=turf.centroid(layer.feature);
    L.marker([c.geometry.coordinates[1],c.geometry.coordinates[0]])
    .bindPopup("<b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©</b><br>Ø§Ù„ØªØ¬Ù…Ø¹: "+name)
    .addTo(proposedLayer);
  }

  layer.setStyle({fillColor:color,fillOpacity:0.6});

  layer.bindPopup(
    "<b>ØªØ¬Ù…Ø¹ Ø³ÙƒÙ†ÙŠ</b><hr>"+
    "Ø§Ù„Ø§Ø³Ù…: "+name+"<br>"+
    "Ø§Ù„Ø³ÙƒØ§Ù†: "+pop+"<br>"+
    "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: "+count+"<br>"+
    "Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: "+needed
  );
});

proposedLayer.addTo(map);
loadOtherLayers();
}

// =======================
// 6ï¸âƒ£ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù„ÙŠØ±Ø§Øª
// =======================
function loadOtherLayers(){

// Ø·Ø±Ù‚
fetch("roads.json").then(r=>r.json()).then(d=>{
  roadsLayer=L.geoJSON(d,{style:{color:"#555",weight:3,dashArray:"5,5"}}).addTo(map);
});

// Ø£ÙˆØ¯ÙŠØ©
fetch("wadis.geojson").then(r=>r.json()).then(d=>{
  wadisLayer=L.geoJSON(d,{style:{color:"#00bcd4",weight:2}}).addTo(map);
});

// Ù…Ù†Ø§Ø·Ù‚ Ø·Ø¨ÙŠØ¹ÙŠØ©
fetch("natural.json").then(r=>r.json()).then(d=>{
  naturalLayer=L.geoJSON(d,{style:{color:"green",fillOpacity:0.4}}).addTo(map);
});

// Ù…Ù†Ø§Ø·Ù‚ Ø¹Ø³ÙƒØ±ÙŠØ©
fetch("military.geojson").then(r=>r.json()).then(d=>{
  militaryLayer=L.geoJSON(d,{style:{color:"black",fillOpacity:0.4}}).addTo(map);
});

// =======================
// Ø§Ù„ÙƒØ³Ø§Ø±Ø§Øª â›ï¸ (Ù…Ø«Ù„Ø« ÙˆØ§Ø¶Ø­)
// =======================
fetch("quarries.geojson")
.then(r=>r.json())
.then(d=>{
  quarriesLayer = L.geoJSON(d,{
    onEachFeature:(f,l)=>{
      let c=turf.centroid(f);
      L.marker(
        [c.geometry.coordinates[1],c.geometry.coordinates[0]],
        {icon:quarryIcon}
      )
      .bindPopup("<b>ÙƒØ³Ø§Ø±Ø©</b>")
      .addTo(map);
    }
  });
});

// Ø¨Ø¤Ø±
fetch("outposts.geojson").then(r=>r.json()).then(d=>{
  outpostsLayer=L.geoJSON(d,{
    pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
      radius:6,color:"#6a1b9a",fillOpacity:0.7
    })
  }).addTo(map);
});

// Ù…Ø³ØªÙˆØ·Ù†Ø§Øª
fetch("settlements.geojson").then(r=>r.json()).then(d=>{
  coloniesLayer=L.geoJSON(d,{style:{color:"red",weight:2,fillOpacity:0.3}}).addTo(map);
  layerControl();
});
}

// =======================
// 7ï¸âƒ£ Layer Control
// =======================
function layerControl(){
L.control.layers(null,{
  "Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª":settlementsLayer,
  "Ø§Ù„Ù…Ø¯Ø§Ø±Ø³":schoolsLayer,
  "Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª":coloniesLayer,
  "Ø§Ù„Ø¨Ø¤Ø±":outpostsLayer,
  "Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù‚ØªØ±Ø­Ø©":proposedLayer,
  "Ø§Ù„Ø·Ø±Ù‚":roadsLayer,
  "Ø§Ù„Ø£ÙˆØ¯ÙŠØ©":wadisLayer,
  "Ù…Ù†Ø§Ø·Ù‚ Ø·Ø¨ÙŠØ¹ÙŠØ©":naturalLayer,
  "Ù…Ù†Ø§Ø·Ù‚ Ø¹Ø³ÙƒØ±ÙŠØ©":militaryLayer,
  "ÙƒØ³Ø§Ø±Ø§Øª â›ï¸":quarriesLayer
}).addTo(map);
}
</script>

</body>
</html>
