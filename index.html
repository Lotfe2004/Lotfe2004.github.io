<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>ØªØ­Ù„ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ â€“ Ù…Ø­Ø§ÙØ¸Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-search/dist/leaflet-search.min.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }

/* Legend + Info */
.legend {
  background: white;
  padding: 10px;
  line-height: 1.6;
  font-size: 13px;
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
}
.legend i {
  width: 14px;
  height: 14px;
  float: right;
  margin-left: 8px;
  opacity: 0.8;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
<script src="https://unpkg.com/leaflet-control-search/dist/leaflet-search.min.js"></script>

<script>
// =======================
// 1ï¸âƒ£ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
// =======================
var map = L.map("map").setView([31.9, 35.2], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// =======================
// 2ï¸âƒ£ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
// =======================
var schoolIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/167/167707.png",
  iconSize: [25,25]
});

// =======================
// 3ï¸âƒ£ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
// =======================
var settlementsLayer, schoolsLayer, proposedLayer = L.layerGroup();
var areaALayer, areaBLayer, areaCLayer, areaCData;
var roadsLayer, wadisLayer, naturalLayer, militaryLayer;
var outpostsLayer, coloniesLayer, quarriesLayer;

// =======================
// 4ï¸âƒ£ Areas A / B / C
// =======================
fetch("area_A.geojson").then(r=>r.json()).then(d=>{
  areaALayer = L.geoJSON(d,{style:{color:"#4caf50",fillOpacity:0.2}})
  .addTo(map).bindPopup("Area A");
});

fetch("Area_B.geojson").then(r=>r.json()).then(d=>{
  areaBLayer = L.geoJSON(d,{style:{color:"#ffeb3b",fillOpacity:0.2}})
  .addTo(map).bindPopup("Area B");
});

fetch("area_C (1).geojson").then(r=>r.json()).then(d=>{
  areaCData = d;
  areaCLayer = L.geoJSON(d,{style:{color:"#f44336",fillOpacity:0.2}})
  .addTo(map).bindPopup("Area C");
});

// =======================
// 5ï¸âƒ£ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª
// =======================
fetch("tgmooat.json").then(r=>r.json()).then(d=>{
  settlementsLayer = L.geoJSON(d,{
    style:{color:"#333",weight:1,fillColor:"#ddd",fillOpacity:0.4},
    onEachFeature:(f,l)=>{
      let p=f.properties||{};
      l.bindPopup(
        "<b>ØªØ¬Ù…Ø¹ Ø³ÙƒÙ†ÙŠ</b><hr>"+
        "Ø§Ù„Ø§Ø³Ù…: "+(p["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"]||p["NAME"]||"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ")
      );
    }
  }).addTo(map);

  map.fitBounds(settlementsLayer.getBounds());
  loadSchools();
});

// =======================
// 6ï¸âƒ£ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
// =======================
function loadSchools(){
fetch("Ramallah_Schools.json").then(r=>r.json()).then(data=>{
  schoolsLayer = L.geoJSON(data,{
    pointToLayer:(f,latlng)=>L.marker(latlng,{icon:schoolIcon})
      .bindPopup(
        "<b>Ù…Ø¯Ø±Ø³Ø©</b><br>"+
        (f.properties.NAME || f.properties.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")
      )
  }).addTo(map);

  analyze(data);
});
}

// =======================
// 7ï¸âƒ£ Ø§Ù„ØªØ­Ù„ÙŠÙ„ + Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ + Ø§Ù„ØªØ«Ù…ÙŠÙ†
// =======================
function analyze(schoolsData){

settlementsLayer.eachLayer(layer=>{

  let count=0;
  schoolsData.features.forEach(s=>{
    if(turf.booleanPointInPolygon(s,layer.feature)) count++;
  });

  let p=layer.feature.properties||{};
  let name=p["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"]||p["NAME"]||"ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
  let pop=p["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"]||0;

  let needed=Math.ceil(pop/3000);
  let deficit=needed-count;
  let color=deficit>0?"#e74c3c":"#2ecc71";

  if(deficit>0){
    let c=turf.centroid(layer.feature);
    let insideC=false;

    areaCData.features.forEach(ac=>{
      if(turf.booleanPointInPolygon(c,ac)) insideC=true;
    });

    if(!insideC){
      let areaType =
        areaALayer &&
        turf.booleanPointInPolygon(c,areaALayer.toGeoJSON().features[0])
        ? "A" : "B";

      let pricePerM=areaType==="A"?150:100;
      let area=5000;
      let price=(area*pricePerM).toLocaleString();

      L.marker([c.geometry.coordinates[1],c.geometry.coordinates[0]])
      .bindPopup(
        "<b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©</b><hr>"+
        "Ø§Ù„ØªØ¬Ù…Ø¹: "+name+"<br>"+
        "ØªØµÙ†ÙŠÙ Ø§Ù„Ø£Ø±Ø¶: Area "+areaType+"<br>"+
        "Ø§Ù„Ù…Ø³Ø§Ø­Ø©: "+area+" Ù…Â²<br>"+
        "Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©: "+price+" $"
      )
      .addTo(proposedLayer);
    }
  }

  layer.setStyle({fillColor:color,fillOpacity:0.6});
  layer.bindPopup(
    "<b>ØªØ¬Ù…Ø¹ Ø³ÙƒÙ†ÙŠ</b><hr>"+
    "Ø§Ù„Ø§Ø³Ù…: "+name+"<br>"+
    "Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†: "+pop+"<br>"+
    "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: "+count+"<br>"+
    "Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: "+needed
  );
});

proposedLayer.addTo(map);
loadOtherLayers();
}

// =======================
// 8ï¸âƒ£ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù„ÙŠØ±Ø§Øª
// =======================
function simple(file,opt,text,cb){
fetch(file).then(r=>r.json()).then(d=>{
  let l=L.geoJSON(d,opt).addTo(map);
  l.eachLayer(x=>x.bindPopup("<b>"+text+"</b>"));
  cb(l);
});
}

function loadOtherLayers(){
simple("roads.json",{style:{color:"#555",weight:3}},"Ø·Ø±ÙŠÙ‚",l=>roadsLayer=l);
simple("wadis.geojson",{style:{color:"#00bcd4"}},"ÙˆØ§Ø¯ÙŠ",l=>wadisLayer=l);
simple("natural.json",{style:{color:"green",fillOpacity:0.4}},"Ù…Ù†Ø·Ù‚Ø© Ø·Ø¨ÙŠØ¹ÙŠØ©",l=>naturalLayer=l);
simple("military.geojson",{style:{color:"black",fillOpacity:0.4}},"Ù…Ù†Ø·Ù‚Ø© Ø¹Ø³ÙƒØ±ÙŠØ©",l=>militaryLayer=l);

fetch("quarries.geojson").then(r=>r.json()).then(d=>{
  quarriesLayer=L.geoJSON(d,{
    pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
      radius:8,color:"#000",fillColor:"#000",fillOpacity:0.8
    }).bindPopup("<b>ÙƒØ³Ø§Ø±Ø©</b>")
  }).addTo(map);
});

fetch("outposts.geojson").then(r=>r.json()).then(d=>{
  outpostsLayer=L.geoJSON(d,{
    pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
      radius:6,color:"#6a1b9a",fillOpacity:0.7
    }).bindPopup("<b>Ø¨Ø¤Ø±Ø©</b>")
  }).addTo(map);
});

fetch("settlements.geojson").then(r=>r.json()).then(d=>{
  coloniesLayer=L.geoJSON(d,{
    style:{color:"red",weight:2,fillOpacity:0.3},
    onEachFeature:(f,l)=>{
      l.bindPopup("<b>Ù…Ø³ØªÙˆØ·Ù†Ø©</b><br>"+(f.properties.NAME||""));
    }
  }).addTo(map);

  layerControl();
});
}

// =======================
// 9ï¸âƒ£ Layer Control
// =======================
function layerControl(){
L.control.layers(null,{
  "Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª":settlementsLayer,
  "Ø§Ù„Ù…Ø¯Ø§Ø±Ø³":schoolsLayer,
  "Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù‚ØªØ±Ø­Ø©":proposedLayer,
  "Area A":areaALayer,
  "Area B":areaBLayer,
  "Area C":areaCLayer,
  "Ø·Ø±Ù‚":roadsLayer,
  "Ø£ÙˆØ¯ÙŠØ©":wadisLayer,
  "Ù…Ù†Ø§Ø·Ù‚ Ø·Ø¨ÙŠØ¹ÙŠØ©":naturalLayer,
  "Ù…Ù†Ø§Ø·Ù‚ Ø¹Ø³ÙƒØ±ÙŠØ©":militaryLayer,
  "ÙƒØ³Ø§Ø±Ø§Øª":quarriesLayer,
  "Ø¨Ø¤Ø±":outpostsLayer,
  "Ù…Ø³ØªÙˆØ·Ù†Ø§Øª":coloniesLayer
}).addTo(map);
}

// =======================
// ğŸ”Ÿ Legend
// =======================
var legend=L.control({position:"bottomright"});
legend.onAdd=function(){
  var d=L.DomUtil.create("div","legend");
  d.innerHTML+="<b>Legend</b><hr>";
  d.innerHTML+="<i style='background:#2ecc71'></i> ØªØ¬Ù…Ø¹ Ù…ÙƒØªÙÙŠ<br>";
  d.innerHTML+="<i style='background:#e74c3c'></i> ØªØ¬Ù…Ø¹ Ø¨Ø­Ø§Ø¬Ø© Ù„Ù…Ø¯Ø±Ø³Ø©<br>";
  d.innerHTML+="ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­<br>";
  d.innerHTML+="<i style='background:#4caf50'></i> Area A<br>";
  d.innerHTML+="<i style='background:#ffeb3b'></i> Area B<br>";
  d.innerHTML+="<i style='background:#f44336'></i> Area C<br>";
  d.innerHTML+="<i style='background:#000'></i> ÙƒØ³Ø§Ø±Ø©<br>";
  d.innerHTML+="<i style='background:#6a1b9a'></i> Ø¨Ø¤Ø±Ø©<br>";
  d.innerHTML+="<i style='background:red'></i> Ù…Ø³ØªÙˆØ·Ù†Ø©<br>";
  return d;
};
legend.addTo(map);

// =======================
// ğŸ” Search â€“ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª
// =======================
var searchSettlements = new L.Control.Search({
  layer: settlementsLayer,
  propertyName: "Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹",
  marker: false
});
searchSettlements.on("search:locationfound",e=>e.layer.openPopup());
map.addControl(searchSettlements);

// =======================
// ğŸ” Search â€“ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
// =======================
var searchSchools = new L.Control.Search({
  layer: schoolsLayer,
  propertyName: "NAME",
  marker: false
});
searchSchools.on("search:locationfound",e=>e.layer.openPopup());
map.addControl(searchSchools);

// =======================
// ğŸ“ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
// =======================
map.on("click",function(e){
  L.popup()
   .setLatLng(e.latlng)
   .setContent(
     "<b>Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª</b><br>"+
     "Lat: "+e.latlng.lat.toFixed(5)+"<br>"+
     "Lng: "+e.latlng.lng.toFixed(5)
   )
   .openOn(map);
});

// =======================
// ğŸ”„ Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶
// =======================
var reset=L.control({position:"topleft"});
reset.onAdd=function(){
  var d=L.DomUtil.create("div","leaflet-bar leaflet-control");
  d.innerHTML="<a href='#'>ğŸ </a>";
  d.onclick=function(){ map.fitBounds(settlementsLayer.getBounds()); };
  return d;
};
reset.addTo(map);

</script>
</body>
</html>
