<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© (Ø±Ø§Ù… Ø§Ù„Ù„Ù‡)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }
.header {
  position:absolute; top:0; left:0; right:0;
  background:#1e3d59; color:white;
  padding:10px; z-index:1000;
  text-align:center;
}
table { width:100%; border-collapse:collapse }
td { border:1px solid #ccc; padding:4px; font-size:12px }
</style>
</head>

<body>

<div class="header">
<h3>ØªØ­Ù„ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ ÙˆØ§Ù‚ØªØ±Ø§Ø­ Ù…ÙˆØ§Ù‚Ø¹ Ø¬Ø¯ÙŠØ¯Ø© â€“ Ù…Ø­Ø§ÙØ¸Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</h3>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// ================= MAP =================
var map = L.map("map").setView([31.9, 35.2], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// ================= POPUP BUILDER =================
function buildPopup(properties){
  let html="<table>";
  for(let k in properties){
    html+=`<tr><td><b>${k}</b></td><td>${properties[k]}</td></tr>`;
  }
  html+="</table>";
  return html;
}

// ================= LOAD DATA =================
Promise.all([
 fetch("tgmooat.json").then(r=>r.json()),
 fetch("Ramallah_Schools.json").then(r=>r.json()),
 fetch("built_up.json").then(r=>r.json()),
 fetch("roads.json").then(r=>r.json()),
 fetch("settlements.geojson").then(r=>r.json()),
 fetch("outposts.geojson").then(r=>r.json()),
 fetch("military.geojson").then(r=>r.json()),
 fetch("wadis.geojson").then(r=>r.json()),
 fetch("Wells.geojson").then(r=>r.json()),
 fetch("clinics.geojson").then(r=>r.json()),
 fetch("hospitals.geojson").then(r=>r.json()),
 fetch("quarries.geojson").then(r=>r.json()),
 fetch("natural.json").then(r=>r.json())
]).then(init);

// ================= INIT =================
function init(data){

let tgmooat=data[0], schools=data[1], built=data[2], roads=data[3];
let settlements=data[4], outposts=data[5], military=data[6], wadis=data[7];
let wells=data[8], clinics=data[9], hospitals=data[10];
let quarries=data[11], natural=data[12];

let overlays={};

// ================= ADD LAYER FUNCTION =================
function addLayer(geojson, options, name){
  let layer=L.geoJSON(geojson,{
    ...options,
    onEachFeature:(f,l)=>{
      l.bindPopup("<b>Attributes</b><hr>"+buildPopup(f.properties));
    }
  }).addTo(map);
  overlays[name]=layer;
  return layer;
}

// ================= BASE LAYERS =================
addLayer(built,{style:{color:"#999",fillOpacity:0.3}},"Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø¨Ù†ÙŠØ©");
addLayer(roads,{style:{color:"orange"}},"Ø§Ù„Ø·Ø±Ù‚");
addLayer(settlements,{style:{color:"red"}},"Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª");
addLayer(outposts,{style:{color:"darkred"}},"Ø§Ù„Ø¨Ø¤Ø±");
addLayer(military,{style:{color:"black"}},"Ù…Ù†Ø§Ø·Ù‚ Ø¹Ø³ÙƒØ±ÙŠØ©");
addLayer(wadis,{style:{color:"blue"}},"Ø§Ù„Ø£ÙˆØ¯ÙŠØ©");
addLayer(quarries,{style:{color:"brown"}},"Ø§Ù„ÙƒØ³Ø§Ø±Ø§Øª");
addLayer(natural,{style:{color:"green"}},"Ù…Ù†Ø§Ø·Ù‚ Ø·Ø¨ÙŠØ¹ÙŠØ©");

addLayer(wells,{pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5,color:"cyan"})},"Ø¢Ø¨Ø§Ø±");
addLayer(clinics,{pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5,color:"purple"})},"Ø¹ÙŠØ§Ø¯Ø§Øª");
addLayer(hospitals,{pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:6,color:"darkblue"})},"Ù…Ø³ØªØ´ÙÙŠØ§Øª");

// ================= SCHOOLS =================
let schoolLayer = L.geoJSON(schools,{
 pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:6,color:"blue",fillOpacity:0.8}),
 onEachFeature:(f,l)=>l.bindPopup("<b>Ù…Ø¯Ø±Ø³Ø©</b><hr>"+buildPopup(f.properties))
}).addTo(map);
overlays["Ø§Ù„Ù…Ø¯Ø§Ø±Ø³"]=schoolLayer;

// ================= SEARCH =================
L.Control.geocoder({defaultMarkGeocode:false})
.on("markgeocode",e=>map.fitBounds(e.geocode.bbox))
.addTo(map);

// ================= MAIN ANALYSIS (Tgmooat) =================
let tgLayer=L.geoJSON(tgmooat,{
 style:{color:"black",fillOpacity:0.15},
 onEachFeature:(f,l)=>{
   let pop=f.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"]||0;
   let needed=Math.ceil(pop/3000);
   let count=schools.features.filter(s=>turf.booleanPointInPolygon(s,f)).length;
   let deficit=count<needed;

   let analysis=`
   <hr><b>Ø§Ù„ØªØ­Ù„ÙŠÙ„</b><br>
   ğŸ‘¥ Ø§Ù„Ø³ÙƒØ§Ù†: ${pop}<br>
   ğŸ« Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${count}<br>
   ğŸ“Š Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${needed}<br>
   âš ï¸ Ø§Ù„Ø­Ø§Ù„Ø©: ${deficit?"Ù†Ù‚Øµ":"ÙƒØ§ÙÙ"}
   `;

   if(deficit){
     let c=turf.centroid(f);
     let price=80;

     if(turf.booleanPointInPolygon(c,built)) price+=25;
     if(turf.distance(c,roads.features[0],{units:"kilometers"})<0.3) price+=20;
     if(turf.distance(c,hospitals.features[0],{units:"kilometers"})<1) price+=15;

     L.marker([c.geometry.coordinates[1],c.geometry.coordinates[0]])
      .addTo(map)
      .bindPopup(`
        <b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ø¯Ø±Ø³Ø© Ù…Ù‚ØªØ±Ø­</b><br>
        ğŸ’° ØªØ«Ù…ÙŠÙ† Ø§Ù„Ø£Ø±Ø¶: ${price} $ / Ù…Â²
      `);

     analysis+="<br>ğŸ—ï¸ ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ Ù…ÙˆÙ‚Ø¹";
   }

   l.bindPopup(
     "<b>Attributes</b><hr>"+buildPopup(f.properties)+analysis
   );
 }
}).addTo(map);

overlays["Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©"]=tgLayer;

// ================= LAYER CONTROL =================
L.control.layers(null,overlays).addTo(map);
map.fitBounds(tgLayer.getBounds());

}
</script>

</body>
</html>
