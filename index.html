<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ Ramallah Schools Project</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }
</style>
</head>

<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// =======================
// Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
// =======================
var map = L.map("map").setView([31.9, 35.2], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

var tgLayer, schoolsData, roadsData;
var settlementsBuffer = null;

// =======================
// Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª + Buffer
// =======================
fetch("settlements.geojson")
.then(r => r.json())
.then(data => {
  L.geoJSON(data,{style:{color:"purple",weight:2,fillOpacity:0.4}}).addTo(map);
  settlementsBuffer = turf.buffer(data,1000,{units:"meters"});
  L.geoJSON(settlementsBuffer,{
    style:{color:"red",dashArray:"5,5",fillOpacity:0.1}
  }).addTo(map);
});

// =======================
// Ø§Ù„Ø·Ø±Ù‚
// =======================
fetch("roads.json")
.then(r => r.json())
.then(data => {
  roadsData = data;
  L.geoJSON(data,{style:{color:"#444",weight:2}}).addTo(map);
});

// =======================
// Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª
// =======================
fetch("tgmooat.json")
.then(r => r.json())
.then(data => {
  tgLayer = L.geoJSON(data,{
    style:{color:"black",weight:1,fillOpacity:0.4}
  }).addTo(map);
  map.fitBounds(tgLayer.getBounds());
  loadSchools();
});

// =======================
// Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ + Ø§Ù„ØªØ­Ù„ÙŠÙ„
// =======================
function loadSchools(){

fetch("Ramallah_Schools.json")
.then(r => r.json())
.then(data => {

  schoolsData = data;

  L.geoJSON(data,{
    pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
      radius:5,color:"blue",fillOpacity:0.8
    })
  }).addTo(map);

  tgLayer.eachLayer(function(layer){

    let count = 0;
    schoolsData.features.forEach(s=>{
      if(turf.booleanPointInPolygon(s,layer.feature)) count++;
    });

    let name = layer.feature.properties["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    let pop  = layer.feature.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || 0;
    let needed = Math.ceil(pop/3000);
    let deficit = needed - count;

    let color = deficit>0 ? "red" : "green";
    layer.setStyle({fillColor:color,fillOpacity:0.6});

    layer.bindPopup(
      "<b>Ø§Ø³Ù… Ø§Ù„ØªØ¬Ù…Ø¹:</b> "+name+"<br>"+
      "<b>Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†:</b> "+pop+"<br>"+
      "<b>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:</b> "+count+"<br>"+
      "<b>Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</b> "+needed+"<br>"+
      "<b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> "+(deficit>0?"ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ":"Ù…ÙƒØªÙÙŠ")
    );

    // =======================
    // Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù‚ØªØ±Ø­Ø©
    // =======================
    if(deficit>0){

      let center = turf.centroid(layer.feature);
      let score = 30; // ÙˆØ¬ÙˆØ¯ Ù†Ù‚Øµ

      // Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª
      let settlementOK = true;
      if(settlementsBuffer && turf.booleanPointInPolygon(center,settlementsBuffer)){
        settlementOK = false;
      } else {
        score += 40;
      }

      // Ø§Ù„Ø·Ø±Ù‚
      let roadDist = turf.pointToLineDistance(center,roadsData,{units:"meters"});
      let roadOK = roadDist<=300;
      if(roadOK) score += 30;

      // ØªØ³Ø¹ÙŠØ± Ø§Ù„Ø£Ø±Ø¶
      let price = "Ù…Ù†Ø®ÙØ¶";
      if(score>=80) price="Ù…Ø±ØªÙØ¹";
      else if(score>=60) price="Ù…ØªÙˆØ³Ø·";

      // Ù„ÙˆÙ† Marker
      let iconColor = score>=80?"green":score>=60?"orange":"red";

      let icon = L.divIcon({
        html:`<div style="background:${iconColor};width:14px;height:14px;border-radius:50%"></div>`
      });

      L.marker([
        center.geometry.coordinates[1],
        center.geometry.coordinates[0]
      ],{icon:icon})
      .addTo(map)
      .bindPopup(
        "<b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©</b><br>"+
        "<b>Ø§Ù„ØªØ¬Ù…Ø¹:</b> "+name+"<br>"+
        "<b>Ø§Ù„Ù…Ù„Ø§Ø¡Ù…Ø©:</b> "+score+"/100<br>"+
        "<b>Ù‚Ø±Ø¨ Ø§Ù„Ø·Ø±Ù‚:</b> "+Math.round(roadDist)+" Ù…<br>"+
        "<b>Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª:</b> "+(settlementOK?"Ø¨Ø¹ÙŠØ¯":"Ù‚Ø±ÙŠØ¨")+"<br>"+
        "<b>Ø³Ø¹Ø± Ø§Ù„Ø£Ø±Ø¶ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</b> "+price
      );
    }
  });
});
}
</script>

</body>
</html>
