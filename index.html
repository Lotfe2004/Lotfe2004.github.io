<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS – Ramallah Schools Project</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }
</style>
</head>

<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// =======================
// 1️⃣ إنشاء الخريطة
// =======================
var map = L.map("map").setView([31.9, 35.2], 11);

// =======================
// 2️⃣ خريطة الأساس
// =======================
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

// متغيرات عامة
var tgLayer;
var schoolsData;

// =======================
// 3️⃣ تحميل التجمعات السكنية
// =======================
fetch("tgmooat.json")
  .then(response => response.json())
  .then(function(tgData){

    tgLayer = L.geoJSON(tgData, {
      style: {
        color: "black",
        weight: 1,
        fillColor: "#7fcdbb",
        fillOpacity: 0.5
      },
      onEachFeature: function(feature, layer){
        // Popup مؤقت (سيتحدث لاحقًا)
        layer.bindPopup("تحميل البيانات...");
      }
    }).addTo(map);

    map.fitBounds(tgLayer.getBounds());

    // بعد تحميل التجمعات، نحمل المدارس
    loadSchools();
  });

// =======================
// 4️⃣ تحميل المدارس + الحساب
// =======================
function loadSchools(){

fetch("Ramallah_Schools.json")
  .then(response => response.json())
  .then(function(sData){

    schoolsData = sData;

    // عرض المدارس
    L.geoJSON(schoolsData, {
      pointToLayer: function(feature, latlng){
        return L.circleMarker(latlng, {
          radius: 5,
          color: "blue",
          fillOpacity: 0.8
        });
      }
    }).addTo(map);

    // تحديث Popup لكل تجمع
    tgLayer.eachLayer(function(layer){

      var count = 0;

      schoolsData.features.forEach(function(school){
        if (turf.booleanPointInPolygon(school, layer.feature)) {
          count++;
        }
      });

      var name = layer.feature.properties["اسم_التجمع"] || "غير معروف";
      var pop  = layer.feature.properties["تقديرات_السكان_2020"] || "غير متوفر";

      layer.bindPopup(
        "<b>اسم التجمع:</b> " + name + "<br>" +
        "<b>عدد السكان:</b> " + pop + "<br>" +
        "<b>عدد المدارس:</b> " + count
      );
    });

  });
}
</script>

</body>
</html>
