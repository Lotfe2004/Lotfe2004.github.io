<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8" />

  <title>Ramallah Waste Containers - Spatial Analysis</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />

  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <style>
    /* style the body */
    body {
      margin: 0px;
      height: 100%;
      width: 100%;
    }

    /* style the map */
    #map {
      position: absolute;
      width: 100%;
      top: 0px;
      bottom: 0;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <script>
    // ----------------------------------------------------
    // 1. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    // ----------------------------------------------------
    // ÙŠØ¬Ø¨ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ù‡Ù†Ø§ Ù„ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù„Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø·Ø¨Ù‚Ø§Øª
    let zonesLayer; 
    let wasteContainersLayer;
    let allContainersFeatureCollection = null; // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Turf

    // define map options
    const mapOptions = {
      zoomSnap: 0.5,  // this allows fractional zooming
      center: [31.9045, 35.2045], // center the map on the coordinates for Ramallah
      zoom: 17.5, // set the initial zoom
    };

    // define the map with the options above
    const map = L.map("map", mapOptions);

    // add a base map to the map
    const darkTileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(map);

    // ----------------------------------------------------
    // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    // ----------------------------------------------------

    // ØªØ­Ù…ÙŠÙ„ Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù†ÙØ§ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
    $.getJSON("wasteContainer.json", function(WC) {
        // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª ÙÙŠ Ù…ØªØºÙŠØ± Turf.js Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„
        allContainersFeatureCollection = turf.featureCollection(WC.features);

        wasteContainersLayer = L.geoJson(WC, {
            pointToLayer: function(feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 5,
                    fillColor: "orange",
                    color: "orange",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            },
            onEachFeature: function(feature, layer) {
                // ØªØ­Ø¯ÙŠØ« Ù„Ù€ Popup Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† alert
                const content = `<strong>Ù†ÙˆØ¹ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª:</strong> ${feature.properties.TYPE_OF_WA || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
                layer.bindPopup(content);
            }
        });
        wasteContainersLayer.addTo(map);

        // Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ§ØªØŒ Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
        loadZones();
        updateLayerControl();
    });

    // Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
    function loadZones() {
        $.getJSON("RamallahZones.json", function(RZ) {
            zonesLayer = L.geoJson(RZ, {
                style: function(feature) {
                    return {
                        fillColor: "yellow",
                        fillOpacity: 0.3,
                        color: "yellow",
                        weight: 1.0,
                        opacity: 0.7
                    };
                },
                onEachFeature: function(feature, layer) {
                    layer.on('click', function(e) {
                        // ---------------------------------------------------
                        // **Ø§Ù„Ù…ÙŠØ²Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©**
                        // ---------------------------------------------------
                        if (allContainersFeatureCollection) {
                            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Turf.js Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¯Ø§Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¶Ù„Ø¹
                            const zonePolygon = turf.feature(feature.geometry);
                            const pointsInZone = turf.pointsWithinPolygon(allContainersFeatureCollection, zonePolygon);
                            const count = pointsInZone.features.length;

                            // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Popup Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† alert Ù„Ù†ØªÙŠØ¬Ø© Ø£Ø¬Ù…Ù„
                            const popupContent = `
                                <h4>ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</h4>
                                <strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${feature.properties.NAME || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}<br>
                                <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª:</strong> <span style="font-weight: bold; color: green; font-size: 1.1em;">${count}</span>
                            `;
                            layer.bindPopup(popupContent).openPopup(e.latlng);
                        } else {
                            alert("Zone Name: " + feature.properties.NAME);
                        }
                        // ---------------------------------------------------
                    });
                }
            });
            zonesLayer.addTo(map);
            updateLayerControl();
        });
    }

    // ----------------------------------------------------
    // 3. Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø·Ø¨Ù‚Ø§Øª (ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­)
    // ----------------------------------------------------

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø·Ø¨Ù‚Ø§Øª
    function updateLayerControl() {
        if (zonesLayer && wasteContainersLayer) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            map.eachControl(function(control) {
                if (control._container && control._container.className.includes('leaflet-control-layers')) {
                    map.removeControl(control);
                }
            });

            const baseLayers = {
              "Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¯Ø§ÙƒÙ†Ø©": darkTileLayer
            };
            const overlays = {
              "Ù…Ù†Ø§Ø·Ù‚ Ø±Ø§Ù… Ø§Ù„Ù„Ù‡ ğŸ™ï¸": zonesLayer,
              "Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù†ÙØ§ÙŠØ§Øª ğŸ—‘ï¸": wasteContainersLayer
            };

            L.control.layers(baseLayers, overlays).addTo(map);
        }
    }
    
  </script>
</body>

</html>

