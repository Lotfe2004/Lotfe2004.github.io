<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ Ramallah Schools Project</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }
</style>
</head>

<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// =======================
// 1ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
// =======================
var map = L.map("map").setView([31.9, 35.2], 11);

// =======================
// 2ï¸âƒ£ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø§Ø³
// =======================
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
var tgLayer;
var schoolsData;
var proposedSites = [];

// =======================
// 3ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©
// =======================
fetch("tgmooat.json")
  .then(response => response.json())
  .then(function(tgData){

    tgLayer = L.geoJSON(tgData, {
      style: {
        color: "black",
        weight: 1,
        fillColor: "#cccccc",
        fillOpacity: 0.4
      }
    }).addTo(map);

    map.fitBounds(tgLayer.getBounds());

    loadSchools();
  });

// =======================
// 4ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ + Ø§Ù„ØªØ­Ù„ÙŠÙ„
// =======================
function loadSchools(){

fetch("Ramallah_Schools.json")
  .then(response => response.json())
  .then(function(sData){

    schoolsData = sData;

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
    L.geoJSON(schoolsData, {
      pointToLayer: function(feature, latlng){
        return L.circleMarker(latlng, {
          radius: 5,
          color: "blue",
          fillOpacity: 0.8
        });
      }
    }).addTo(map);

    // =======================
    // 5ï¸âƒ£ Ø§Ù„ØªØ­Ù„ÙŠÙ„ + Ø§Ù‚ØªØ±Ø§Ø­ Ù…ÙˆÙ‚Ø¹
    // =======================
    tgLayer.eachLayer(function(layer){

      var count = 0;

      schoolsData.features.forEach(function(school){
        if (turf.booleanPointInPolygon(school, layer.feature)) {
          count++;
        }
      });

      var name = layer.feature.properties["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
      var pop  = layer.feature.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || 0;

      var needed = Math.ceil(pop / 3000);
      var deficit = needed - count;

      var status = "Ù…ÙƒØªÙÙŠ";
      var color = "green";

      if (deficit > 0) {
        status = "ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ Ù…Ø¯Ø§Ø±Ø³";
        color = "red";

        // Ø§Ù‚ØªØ±Ø§Ø­ Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· Ù„ÙƒÙ„ ØªØ¬Ù…Ø¹
        if (!layer._siteProposed) {

          var center = turf.centroid(layer.feature);

          var marker = L.marker([
            center.geometry.coordinates[1],
            center.geometry.coordinates[0]
          ])
          .addTo(map)
          .bindPopup(
            "<b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©</b><br>" +
            "<b>Ø§Ù„ØªØ¬Ù…Ø¹:</b> " + name
          );

          proposedSites.push(marker);
          layer._siteProposed = true;
        }
      }

      // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØªØ¬Ù…Ø¹
      layer.setStyle({
        fillColor: color,
        fillOpacity: 0.6
      });

      // Popup Ø§Ù„ØªØ¬Ù…Ø¹
      layer.bindPopup(
        "<b>Ø§Ø³Ù… Ø§Ù„ØªØ¬Ù…Ø¹:</b> " + name + "<br>" +
        "<b>Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†:</b> " + pop + "<br>" +
        "<b>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:</b> " + count + "<br>" +
        "<b>Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</b> " + needed + "<br>" +
        "<b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> " + status
      );
    });

  });
}
</script>

</body>
</html>
