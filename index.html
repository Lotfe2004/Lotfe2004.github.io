<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>Web GIS â€“ Ramallah Schools Project</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }
</style>
</head>

<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// =======================
// 1ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
// =======================
var map = L.map("map").setView([31.9, 35.2], 11);

// =======================
// 2ï¸âƒ£ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ø³Ø§Ø³
// =======================
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "Â© OpenStreetMap"
}).addTo(map);

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
var tgLayer;
var schoolsData;

// =======================
// 3ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©
// =======================
fetch("tgmooat.json")
.then(res => res.json())
.then(tgData => {

  tgLayer = L.geoJSON(tgData, {
    style: {
      color: "#333",
      weight: 1,
      fillColor: "#dddddd",
      fillOpacity: 0.4
    }
  }).addTo(map);

  map.fitBounds(tgLayer.getBounds());

  loadSchools();
});

// =======================
// 4ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ + Ø§Ù„ØªØ­Ù„ÙŠÙ„
// =======================
function loadSchools(){

fetch("Ramallah_Schools.json")
.then(res => res.json())
.then(sData => {

  schoolsData = sData;

  // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
  L.geoJSON(schoolsData, {
    pointToLayer: function(feature, latlng){
      return L.circleMarker(latlng, {
        radius: 5,
        color: "blue",
        fillColor: "blue",
        fillOpacity: 0.9
      }).bindPopup(
        "<b>Ù…Ø¯Ø±Ø³Ø©</b><br>" +
        (feature.properties.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")
      );
    }
  }).addTo(map);

  // =======================
  // 5ï¸âƒ£ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù„ÙƒÙ„ ØªØ¬Ù…Ø¹
  // =======================
  tgLayer.eachLayer(layer => {

    var schoolsCount = 0;

    schoolsData.features.forEach(school => {
      if (turf.booleanPointInPolygon(school, layer.feature)) {
        schoolsCount++;
      }
    });

    var p = layer.feature.properties || {};

    var name =
      p["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"] ||
      p["name"] ||
      p["NAME"] ||
      "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

    var population =
      p["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] ||
      p["population"] ||
      0;

    var neededSchools = Math.ceil(population / 3000);
    var deficit = neededSchools - schoolsCount;

    var status = "Ù…ÙƒØªÙÙŠ";
    var color = "#2ecc71";

    if (deficit > 0) {
      status = "ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ Ù…Ø¯Ø§Ø±Ø³";
      color = "#e74c3c";

      var center = turf.centroid(layer.feature);

      var landArea = 5000;
      var pricePerMeter = 120;
      var price = landArea * pricePerMeter + " $";

      L.marker([
        center.geometry.coordinates[1],
        center.geometry.coordinates[0]
      ])
      .addTo(map)
      .bindPopup(
        "<b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©</b><hr>" +
        "<b>Ø§Ù„ØªØ¬Ù…Ø¹:</b> " + name + "<br>" +
        "<b>Ø§Ù„Ù…Ø³Ø§Ø­Ø©:</b> " + landArea + " Ù…Â²<br>" +
        "<b>Ø³Ø¹Ø± ØªÙ‚Ø±ÙŠØ¨ÙŠ:</b> " + price
      );
    }

    layer.setStyle({
      fillColor: color,
      fillOpacity: 0.6
    });

    layer.bindPopup(
      "<b>ØªØ¬Ù…Ø¹ Ø³ÙƒÙ†ÙŠ</b><hr>" +
      "<b>Ø§Ù„Ø§Ø³Ù…:</b> " + name + "<br>" +
      "<b>Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†:</b> " + population + "<br>" +
      "<b>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³:</b> " + schoolsCount + "<br>" +
      "<b>Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</b> " + neededSchools + "<br>" +
      "<b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> " + status
    );

  });

});
}

// =======================
// 6ï¸âƒ£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª (Ø¥Ø¶Ø§ÙØ© ÙÙ‚Ø· â€“ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªÙØ§Ø¹Ù„)
// =======================
fetch("settlements.geojson")
.then(res => res.json())
.then(data => {

  L.geoJSON(data, {
    style: {
      color: "red",
      weight: 2,
      fillColor: "red",
      fillOpacity: 0.3
    },
    onEachFeature: function(feature, layer){
      layer.bindPopup("<b>Ù…Ø³ØªÙˆØ·Ù†Ø©</b>");
    }
  }).addTo(map);

});
</script>

</body>
</html>
