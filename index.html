<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>ØªØ­Ù„ÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ â€“ Ù…Ø­Ø§ÙØ¸Ø© Ø±Ø§Ù… Ø§Ù„Ù„Ù‡</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">

<style>
body { margin:0; font-family:Arial }
#map { height:100vh }
.header {
  position:absolute;
  top:0; left:0; right:0;
  background:#1e3d59;
  color:white;
  padding:10px;
  z-index:1000;
  text-align:center;
}
table {
  width:100%;
  border-collapse:collapse;
}
td {
  border:1px solid #ccc;
  padding:4px;
  font-size:12px;
}
</style>
</head>

<body>

<div class="header">
<h3>ØªØ­Ù„ÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø­Ø³Ø¨ Ø§Ù„ØªØ¬Ù…Ø¹Ø§Øª Ø§Ù„Ø³ÙƒÙ†ÙŠØ©</h3>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
// ================= MAP =================
var map = L.map("map").setView([31.9, 35.2], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// ================= LOAD DATA =================
Promise.all([
  fetch("tgmooat.json").then(r=>r.json()),
  fetch("Ramallah_Schools.json").then(r=>r.json()),
  fetch("settlements.geojson").then(r=>r.json()),
  fetch("built_up.json").then(r=>r.json()),
  fetch("roads.json").then(r=>r.json())
]).then(init);

// ================= INIT =================
function init(data){

let tgmooat = data[0];
let schools = data[1];
let settlements = data[2];
let built = data[3];
let roads = data[4];

// ================= SHOW OTHER LAYERS =================
// Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
L.geoJSON(schools,{
  pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:5,color:"blue",fillOpacity:0.8})
}).addTo(map);

// Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ø¨Ù†ÙŠØ©
L.geoJSON(built,{style:{color:"#999",fillOpacity:0.3}}).addTo(map);

// Ø§Ù„Ø·Ø±Ù‚
L.geoJSON(roads,{style:{color:"orange",weight:2}}).addTo(map);

// Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª
L.geoJSON(settlements,{style:{color:"red",fillOpacity:0.4}}).addTo(map);

// ================= SEARCH =================
L.Control.geocoder({
  defaultMarkGeocode:false
}).on("markgeocode",function(e){
  map.fitBounds(e.geocode.bbox);
}).addTo(map);

// ================= MAIN LAYER: TGMO3AT =================
L.geoJSON(tgmooat,{
 style:{color:"black",fillOpacity:0.2},
 onEachFeature:function(feature, layer){

   layer.on("click", function(){

     // ===== BASIC ANALYSIS =====
     let pop = feature.properties["ØªÙ‚Ø¯ÙŠØ±Ø§Øª_Ø§Ù„Ø³ÙƒØ§Ù†_2020"] || 0;
     let needed = Math.ceil(pop / 3000);

     let schoolCount = schools.features.filter(s =>
       turf.booleanPointInPolygon(s, feature)
     ).length;

     let deficit = schoolCount < needed;

     let html = `
     <b>${feature.properties["Ø§Ø³Ù…_Ø§Ù„ØªØ¬Ù…Ø¹"]}</b><br>
     ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙƒØ§Ù†: ${pop}<br>
     ğŸ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø§Ø±Ø³: ${schoolCount}<br>
     ğŸ“Š Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ${needed}<br>
     âš ï¸ Ø§Ù„Ø­Ø§Ù„Ø©: ${deficit ? "ÙŠÙˆØ¬Ø¯ Ù†Ù‚Øµ" : "Ù…ÙƒØªÙÙŠ"}
     `;

     // ===== IF DEFICIT =====
     if(deficit){

       let center = turf.centroid(feature);

       // Ø§Ù„Ø¨Ø¹Ø¯ Ø¹Ù† Ø§Ù„Ù…Ø³ØªÙˆØ·Ù†Ø§Øª
       let farFromSettlements = true;
       settlements.features.forEach(s=>{
         if(turf.distance(center, s, {units:"kilometers"}) < 0.8){
           farFromSettlements = false;
         }
       });

       // Ø¯Ø§Ø®Ù„ Ù…Ù†Ø·Ù‚Ø© Ù…Ø¨Ù†ÙŠØ©
       let insideBuilt = turf.booleanPointInPolygon(center, built);

       // Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø·Ø±ÙŠÙ‚
       let nearRoad = false;
       roads.features.forEach(r=>{
         if(turf.distance(center, r, {units:"kilometers"}) < 0.5){
           nearRoad = true;
         }
       });

       // ===== SUITABILITY =====
       let suitable = farFromSettlements && insideBuilt && nearRoad;

       // ===== LAND VALUATION =====
       let price = 100;
       if(insideBuilt) price += 30;
       if(nearRoad) price += 20;
       if(suitable) price += 20;
       if(!farFromSettlements) price -= 50;

       // ===== SHOW PROPOSED SITE =====
       L.marker(
         [center.geometry.coordinates[1], center.geometry.coordinates[0]]
       ).addTo(map)
        .bindPopup(`
          <b>ğŸ“ Ù…ÙˆÙ‚Ø¹ Ù…Ù‚ØªØ±Ø­ Ù„Ø¨Ù†Ø§Ø¡ Ù…Ø¯Ø±Ø³Ø©</b><br>
          ğŸ§­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${suitable ? "Ù…Ù†Ø§Ø³Ø¨" : "ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨"}<br>
          ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ: ${price} $ / Ù…Â²
        `);

       html += `
       <hr>
       ğŸ§­ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${suitable ? "Ù…Ù†Ø§Ø³Ø¨" : "ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨"}<br>
       ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ: ${price} $ / Ù…Â²
       `;
     }

     layer.bindPopup(html).openPopup();
   });
 }
}).addTo(map);

// Ø¶Ø¨Ø· Ø§Ù„Ø¥Ø·Ø§Ø±
map.fitBounds(L.geoJSON(tgmooat).getBounds());
}
</script>

</body>
</html>
