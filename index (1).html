<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<title>GIS TEST – RAMALLAH</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html,body,#map{
    height:100%;
    margin:0;
}
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ===============================
// 1️⃣ الخريطة
// ===============================
const map = L.map('map').setView([31.903, 35.205], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'© OpenStreetMap'
}).addTo(map);

// ===============================
// 2️⃣ دالة آمنة لتحميل JSON
// ===============================
async function safeLoad(file){
    try{
        const r = await fetch(file);
        if(!r.ok) throw new Error("HTTP error");
        const j = await r.json();
        console.log("Loaded:", file);
        return j;
    }catch(e){
        console.error("FAILED:", file, e);
        return null;
    }
}

// ===============================
// 3️⃣ تصحيح المدارس (مهما كانت)
// ===============================
function fixSchools(data){
    if(!data || !data.features) return [];

    let fixed = [];

    data.features.forEach(f=>{
        // حالة GeoJSON طبيعي
        if(f.geometry && f.geometry.type==="Point"){
            fixed.push(f);
        }
        // حالة East / North
        else if(f.properties && f.properties.East && f.properties.North){
            fixed.push({
                type:"Feature",
                properties:f.properties,
                geometry:{
                    type:"Point",
                    coordinates:[
                        Number(f.properties.East),
                        Number(f.properties.North)
                    ]
                }
            });
        }
        else{
            console.warn("Skipped feature", f);
        }
    });

    console.log("Schools usable:", fixed.length);
    return fixed;
}

// ===============================
// 4️⃣ تحميل وعرض الأحياء
// ===============================
safeLoad("RamallahZones.json").then(zones=>{
    if(!zones) return;

    L.geoJSON(zones,{
        style:{
            color:"red",
            weight:2,
            fillOpacity:0.1
        },
        onEachFeature:(f,l)=>{
            l.bindPopup(f.properties?.NAME || "حي");
        }
    }).addTo(map);

    try{
        map.fitBounds(L.geoJSON(zones).getBounds());
    }catch{}
});

// ===============================
// 5️⃣ تحميل وعرض المدارس (مضمون)
// ===============================
safeLoad("Ramallah_Schools.json").then(data=>{
    const schools = fixSchools(data);

    schools.forEach(s=>{
        const c = s.geometry.coordinates;
        if(!isNaN(c[0]) && !isNaN(c[1])){
            L.circleMarker([c[1],c[0]],{
                radius:5,
                color:"blue",
                fillOpacity:0.8
            }).addTo(map);
        }
    });
});
</script>
</body>
</html>
